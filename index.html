<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMJIN Quotation System v6.0 - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+KR:wght@400;700&family=JetBrains+Mono&display=swap');
        
        :root {
            --primary: #4f46e5;
            --secondary: #10b981;
        }

        body { 
            font-family: 'Noto Sans KR', 'Inter', sans-serif; 
            background-color: #f8fafc;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-track { background: #1e293b; }
        .log-container::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }
        .animate-pulse-soft { animation: pulse-soft 2.5s infinite ease-in-out; }
        
        .matching-active {
            background: linear-gradient(90deg, #4f46e5, #818cf8, #4f46e5);
            background-size: 200% 100%;
            animation: gradient-move 2s linear infinite;
        }
        @keyframes gradient-move {
            0% { background-position: 100% 0%; }
            100% { background-position: -100% 0%; }
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 1.5rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .db-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .db-table th {
            background: #f1f5f9;
            padding: 12px;
            text-align: left;
            font-weight: 700;
            font-size: 0.85rem;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .db-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .db-table tr:hover {
            background: #f8fafc;
        }

        .db-table input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .db-table input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .tab-button:hover {
            color: #4f46e5;
        }

        #pumsumMainTable th,
        #pumsumMainTable td {
            font-size: 9px !important;
            white-space: nowrap;
        }

        #pumsumMainTable {
            min-width: 100%;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-10 text-center relative">
            <div class="inline-block px-4 py-1 rounded-full bg-indigo-100 text-indigo-700 text-xs font-bold mb-3 tracking-widest uppercase">Intelligent Matching Engine + DB Manager</div>
            <h1 class="text-4xl font-extrabold text-slate-900 mb-2 tracking-tight">
                SAMJIN <span class="text-indigo-600">ê²¬ì ì‹œìŠ¤í…œ</span> <span class="text-slate-400 font-light">v6.0</span>
            </h1>
            <p class="text-slate-500 font-medium">ì§€ëŠ¥í˜• ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ + ì‹¤ì‹œê°„ DB ê´€ë¦¬ + n8n ìë™í™”</p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-8 border-b border-slate-200">
            <div class="flex gap-2 overflow-x-auto">
                <button class="tab-button active whitespace-nowrap" onclick="switchTab('matching')">ğŸ¯ ë§¤ì¹­ ì‹œìŠ¤í…œ</button>
                <button class="tab-button whitespace-nowrap" onclick="switchTab('db-manager')">ğŸ“Š DB ê´€ë¦¬</button>
                <button class="tab-button whitespace-nowrap" onclick="switchTab('pumsum-calculator')">ğŸ—ï¸ í’ˆì…ˆ ê³„ì‚°ê¸°</button>
                <button class="tab-button whitespace-nowrap" onclick="switchTab('n8n-config')">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</button>
            </div>
        </div>

        <!-- Tab Content: Matching System -->
        <div id="tab-matching" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left Controls -->
                <div class="lg:col-span-4 space-y-6">
                    
                    <!-- DB Sync Section -->
                    <div class="glass-card p-6 rounded-3xl shadow-xl transition-all hover:shadow-2xl border-t-4 border-t-indigo-500">
                        <div class="flex items-center justify-between mb-5">
                            <h2 class="text-lg font-bold text-slate-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                                ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
                            </h2>
                            <span id="dbStatusBadge" class="px-2 py-1 rounded text-[10px] font-bold bg-slate-200 text-slate-600">IDLE</span>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">DB Selection</label>
                                <select id="sheetSelect" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-700 font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition-all appearance-none cursor-pointer">
                                    <option value="ì„¸í•œ,ì‹ í•œë©”íƒˆ,ì‹ ì¼,í™”ì„±,ë™ì§„,ì˜ì§„,ì¸ì„±,í”„ëŸ¼íŒŒìŠ¤íŠ¸">í˜‘ë ¥ì‚¬ í†µí•©ë‹¨ê°€ (ê³µí†µ)</option>
                                    <option value="2025ë…„">2025ë…„ ì‹ ê·œ ë‹¨ê°€í‘œ</option>
                                    <option value="ckwë‹¨ê°€(ì—…ëƒì˜ˆì •)">CKW ì „ìš© (ì—…ë°ì´íŠ¸ ì˜ˆì •)</option>
                                    <option value="ì •ë¶€ë…¸ì„">ì •ë¶€ ê³µí‘œ ë…¸ì„ë‹¨ê°€</option>
                                    <option value="í•œêµ­ë¬¼ê°€ìë£Œkprc">KPRC ë¬¼ê°€ìë£Œ (Beta)</option>
                                </select>
                            </div>
                            <div id="dbStatusText" class="text-xs text-amber-600 font-semibold flex items-center">
                                <span class="w-2 h-2 bg-amber-500 rounded-full mr-2 animate-pulse"></span>
                                ë°ì´í„° ë™ê¸°í™” ëŒ€ê¸° ì¤‘
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Section -->
                    <div class="glass-card p-6 rounded-3xl shadow-xl transition-all hover:shadow-2xl border-t-4 border-t-blue-500">
                        <h2 class="text-lg font-bold mb-5 text-slate-800 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            ë‚´ì—­ì„œ ì—…ë¡œë“œ
                        </h2>
                        <div class="relative group">
                            <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div class="border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center group-hover:border-blue-400 group-hover:bg-blue-50 transition-all">
                                <svg class="w-10 h-10 mx-auto text-slate-300 group-hover:text-blue-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                <p id="fileNameDisplay" class="text-sm font-medium text-slate-500 group-hover:text-blue-600">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</p>
                                <p class="text-[10px] text-slate-400 mt-2">XLSX, XLS, CSV ì§€ì›</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <button onclick="startWorkerMatch()" id="matchBtn" disabled 
                            class="w-full bg-slate-800 text-white font-bold py-4 px-6 rounded-2xl shadow-xl hover:bg-slate-900 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none transition-all flex items-center justify-center gap-2 transform active:scale-95">
                            <span id="matchBtnText">âš¡ ê³ ì† ë§¤ì¹­ ì‹¤í–‰</span>
                        </button>
                        <button onclick="downloadExcel()" id="downloadBtn" disabled 
                            class="w-full bg-emerald-500 text-white font-bold py-4 px-6 rounded-2xl shadow-xl hover:bg-emerald-600 disabled:opacity-30 disabled:shadow-none transition-all flex items-center justify-center gap-2 transform active:scale-95">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            ê²°ê³¼ ì—‘ì…€ ì €ì¥
                        </button>
                    </div>
                </div>

                <!-- Right Monitor -->
                <div class="lg:col-span-8">
                    <div class="bg-slate-900 rounded-[2rem] p-6 shadow-2xl flex flex-col h-[700px] border border-slate-800 relative overflow-hidden">
                        <!-- Monitor Header -->
                        <div class="flex justify-between items-center mb-4 border-b border-slate-800 pb-4 z-10">
                            <div class="flex items-center gap-2">
                                <div class="flex gap-1.5 mr-3">
                                    <div class="w-3 h-3 bg-rose-500 rounded-full shadow-[0_0_8px_rgba(244,63,94,0.6)]"></div>
                                    <div class="w-3 h-3 bg-amber-500 rounded-full shadow-[0_0_8px_rgba(245,158,11,0.6)]"></div>
                                    <div class="w-3 h-3 bg-emerald-500 rounded-full shadow-[0_0_8px_rgba(16,185,129,0.6)]"></div>
                                </div>
                                <h2 class="text-slate-400 mono text-xs tracking-tighter uppercase opacity-70">Matching Monitor Terminal v6.0</h2>
                            </div>
                            <div class="flex items-center gap-3">
                                <div id="progressContainer" class="hidden w-48 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                    <div id="progressBar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <button onclick="clearLog()" class="text-[10px] mono text-slate-500 hover:text-white border border-slate-700 hover:border-slate-500 px-3 py-1 rounded-full transition-all">CLEAR_LOG</button>
                            </div>
                        </div>
                        
                        <!-- Log Area -->
                        <div id="log" class="log-container flex-1 mono text-[12px] text-indigo-300 overflow-y-auto whitespace-pre-wrap leading-relaxed px-2 py-2"></div>
                        
                        <!-- Console Decoration -->
                        <div class="absolute bottom-4 right-6 opacity-10 pointer-events-none">
                            <svg class="w-24 h-24 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14H11V21L20 10H13Z"></path></svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: DB Manager -->
        <div id="tab-db-manager" class="tab-content hidden">
            <div class="glass-card p-8 rounded-3xl shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬</h2>
                    <div class="flex gap-3">
                        <button onclick="openAddItemModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-indigo-700 transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            í’ˆëª© ì¶”ê°€
                        </button>
                        <!-- Added Delete All Button -->
                        <button onclick="openDeleteAllModal()" class="bg-rose-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-rose-700 transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            ëª¨ë‘ ì‚­ì œ
                        </button>
                    </div>
                </div>

                <div class="mb-4 flex flex-col md:flex-row gap-3">
                    <input type="text" id="searchDB" placeholder="í’ˆëª…, ê·œê²©ìœ¼ë¡œ ê²€ìƒ‰..." class="flex-1 px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    <select id="filterCategory" class="px-4 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                        <option value="ë°°ê´€">ë°°ê´€</option>
                        <option value="ë³´ì˜¨">ë³´ì˜¨</option>
                        <option value="ë°¸ë¸Œ">ë°¸ë¸Œ</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>

                <div class="overflow-auto max-h-[600px] border border-slate-200 rounded-xl">
                    <table class="db-table">
                        <thead>
                            <tr>
                                <th style="width: 5%">#</th>
                                <th style="width: 25%">í’ˆëª…</th>
                                <th style="width: 25%">ê·œê²©</th>
                                <th style="width: 8%">ë‹¨ìœ„</th>
                                <th style="width: 12%">ì¬ë£Œë¹„</th>
                                <th style="width: 12%">ë…¸ë¬´ë¹„</th>
                                <th style="width: 13%">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="dbTableBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <p class="text-sm text-slate-600">ì´ <span id="dbCount" class="font-bold text-indigo-600">0</span>ê°œ í’ˆëª©</p>
                    <div class="flex gap-3">
                        <div class="relative">
                            <input type="file" id="dbExcelUpload" accept=".xlsx, .xls" class="hidden" onchange="importDBFromExcel(event)">
                            <button onclick="document.getElementById('dbExcelUpload').click()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-blue-700 transition-all flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4-4m4 4V4"></path></svg>
                                DB ì—‘ì…€ ì—…ë¡œë“œ
                            </button>
                        </div>
                        <button onclick="exportDBToExcel()" class="bg-slate-700 text-white px-4 py-2 rounded-xl font-semibold hover:bg-slate-800 transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            DB ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Pumsum Calculator -->
        <div id="tab-pumsum-calculator" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="glass-card p-6 rounded-3xl shadow-xl border-t-4 border-t-blue-500">
                    <h3 class="text-sm font-bold text-blue-900 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path></svg>
                        í’ˆì…ˆ ë°ì´í„°ë² ì´ìŠ¤ (v3.5 Engine)
                    </h3>
                    <button id="pumsumSyncBtn" onclick="syncPumsumData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl text-base font-bold shadow-md transition-all active:scale-[0.98]">
                        ğŸ”„ í’ˆì…ˆ DB ë™ê¸°í™”
                    </button>
                    <p id="pumsumSyncStatus" class="mt-3 text-xs text-slate-600 text-center font-medium">ë°ì´í„° ë¡œë“œ ì „ì…ë‹ˆë‹¤.</p>
                </div>

                <div class="glass-card p-6 rounded-3xl shadow-xl border-t-4 border-t-emerald-500">
                    <h3 class="text-sm font-bold text-emerald-900 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        ê³µë‚´ì—­ íŒŒì¼ ì—…ë¡œë“œ
                    </h3>
                    <input type="file" id="pumsumFileInput" accept=".xlsx, .xls" 
                        class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-bold file:bg-emerald-600 file:text-white hover:file:bg-emerald-700 cursor-pointer"
                    />
                </div>

                <div class="glass-card p-6 rounded-3xl shadow-xl border-t-4 border-t-purple-500">
                    <h3 class="text-sm font-bold text-purple-900 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        ì²˜ë¦¬ í†µê³„
                    </h3>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">ì´ í•­ëª©:</span>
                            <span id="pumsumStatTotal" class="font-bold text-purple-700">0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">ë§¤ì¹­ ì ìˆ˜:</span>
                            <span id="pumsumStatScore" class="font-bold text-emerald-600">0 Hits</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">ìƒíƒœ:</span>
                            <span id="pumsumStatStatus" class="font-bold text-slate-400">ëŒ€ê¸°ì¤‘</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div id="pumsumLoading" class="hidden flex-col items-center justify-center py-16 bg-slate-50 rounded-xl">
                <div class="w-12 h-12 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                <p class="text-slate-500 text-lg font-bold">Pro v3.5 ì •ë°€ ë¶„ì„ ì—”ì§„ ê°€ë™ ì¤‘...</p>
                <p class="text-slate-400 text-sm mt-2">ì‰¼í‘œ ìˆ˜ì¹˜ êµì • ë° ë²”ìœ„ ê·œê²© ë§¤ì¹­ ì¤‘</p>
            </div>

            <!-- Result Table Area -->
            <div id="pumsumResultArea" class="hidden">
                <div class="flex items-center justify-between mb-4 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        ì‚°ì¶œ ë‚´ì—­ ê²°ê³¼ (Pro v3.5)
                    </h2>
                    <button onclick="exportPumsumToExcel()" class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:from-emerald-700 hover:to-emerald-800 shadow-lg transition-all active:scale-[0.98] flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
                
                <div class="overflow-x-auto border border-slate-200 rounded-xl shadow-inner max-h-[600px] bg-slate-50">
                    <table class="w-full border-collapse table-fixed bg-white" id="pumsumMainTable" style="font-size: 11px;">
                        <thead id="pumsumTableHeader"></thead>
                        <tbody id="pumsumResultBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div id="pumsumEmptyState" class="py-24 text-center border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                <div class="text-6xl mb-4 opacity-20">ğŸ“‹</div>
                <p class="text-slate-500 text-lg font-semibold mb-2">í’ˆì…ˆ ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”</p>
                <p class="text-slate-400 text-sm">DB ë™ê¸°í™” í›„ ê³µë‚´ì—­ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            </div>
        </div>

        <!-- Tab Content: n8n Config -->
        <div id="tab-n8n-config" class="tab-content hidden">
            <!-- ... existing n8n config content ... -->
             <div class="glass-card p-8 rounded-3xl shadow-xl max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">âš™ï¸ n8n ìë™í™” ì„¤ì •</h2>
                
                <div class="space-y-6">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                        <h3 class="font-bold text-blue-900 mb-2">ğŸ”— n8n Webhook ì—°ë™ ê°€ì´ë“œ</h3>
                        <p class="text-sm text-blue-800 mb-3">ì•„ë˜ Webhook URLì„ n8nì— ì„¤ì •í•˜ì—¬ ìë™í™” ì›Œí¬í”Œë¡œìš°ë¥¼ êµ¬ì¶•í•˜ì„¸ìš”.</p>
                        <ol class="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                            <li>n8nì—ì„œ Webhook ë…¸ë“œ ìƒì„±</li>
                            <li>POST ë©”ì†Œë“œë¡œ ì„¤ì •</li>
                            <li>ìƒì„±ëœ Webhook URLì„ ì•„ë˜ì— ì…ë ¥</li>
                            <li>Google Sheets ë…¸ë“œë¡œ DB ì—…ë°ì´íŠ¸ ìë™í™”</li>
                        </ol>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">n8n Webhook URL (í’ˆëª© ì¶”ê°€ìš©)</label>
                        <input type="text" id="n8nWebhookAdd" placeholder="https://your-n8n-instance.com/webhook/add-item" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm">
                        <p class="text-xs text-slate-500 mt-1">í’ˆëª© ì¶”ê°€ ì‹œ ìë™ìœ¼ë¡œ ì´ URLë¡œ ë°ì´í„° ì „ì†¡</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">n8n Webhook URL (í’ˆëª© ìˆ˜ì •ìš©)</label>
                        <input type="text" id="n8nWebhookUpdate" placeholder="https://your-n8n-instance.com/webhook/update-item" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm">
                        <p class="text-xs text-slate-500 mt-1">í’ˆëª© ìˆ˜ì • ì‹œ ìë™ìœ¼ë¡œ ì´ URLë¡œ ë°ì´í„° ì „ì†¡</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">n8n Webhook URL (í’ˆëª© ì‚­ì œìš©)</label>
                        <input type="text" id="n8nWebhookDelete" placeholder="https://your-n8n-instance.com/webhook/delete-item" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm">
                        <p class="text-xs text-slate-500 mt-1">í’ˆëª© ì‚­ì œ ì‹œ ìë™ìœ¼ë¡œ ì´ URLë¡œ ë°ì´í„° ì „ì†¡</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Google Sheets ID</label>
                        <input type="text" id="googleSheetsId" value="1GaUzextj8jdry2iegBK7EiWDm1VASX8od3o9tP7DoZU" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm">
                        <p class="text-xs text-slate-500 mt-1">í˜„ì¬ ì—°ë™ëœ Google Sheets ë¬¸ì„œ ID</p>
                    </div>

                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="enableAutoSync" class="w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                        <label for="enableAutoSync" class="text-sm font-semibold text-slate-700">ìë™ ë™ê¸°í™” í™œì„±í™” (n8n í•„ìˆ˜)</label>
                    </div>

                    <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg">
                        <h3 class="font-bold text-amber-900 mb-2">ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                        <div class="flex gap-3">
                            <input type="password" id="newAdminPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)" maxlength="4" class="flex-1 px-4 py-2 border border-amber-300 rounded-xl focus:ring-2 focus:ring-amber-500 outline-none font-mono text-center tracking-widest">
                            <button onclick="changePasswordClick()" class="bg-amber-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-amber-700 transition-all">
                                ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                            </button>
                        </div>
                        <p class="text-xs text-amber-700 mt-2">âš ï¸ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ìˆ«ì ë˜ëŠ” ë¬¸ìë¡œ ì„¤ì •í•˜ì„¸ìš”</p>
                    </div>

                    <button onclick="saveN8nConfig()" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition-all">
                        ğŸ’¾ ì„¤ì • ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Add Item, Password, Alert) -->
    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-800">â• ìƒˆ í’ˆëª© ì¶”ê°€</h3>
                <button onclick="closeAddItemModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">í’ˆëª… *</label>
                    <input type="text" id="newItemName" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ì˜ˆ: ë°°ê´€ìš©íƒ„ì†Œê°•ê´€">
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">ê·œê²© *</label>
                    <input type="text" id="newItemSpec" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ì˜ˆ: 80Ax3000L">
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ë‹¨ìœ„ *</label>
                        <input type="text" id="newItemUnit" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="EA">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ì¬ë£Œë¹„</label>
                        <input type="number" id="newItemMat" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">ë…¸ë¬´ë¹„</label>
                        <input type="number" id="newItemLab" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="0">
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="addNewItem()" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-all">
                        ì¶”ê°€í•˜ê¸°
                    </button>
                    <button onclick="closeAddItemModal()" class="px-6 bg-slate-200 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-300 transition-all">
                        ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content p-8" style="max-width: 400px;">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-slate-800">ğŸ” ê´€ë¦¬ì ì¸ì¦</h3>
                <p class="text-sm text-slate-500 mt-2">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            </div>

            <div class="space-y-4">
                <div>
                    <input type="password" id="adminPassword" 
                           class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-center text-lg tracking-widest font-mono" 
                           placeholder="â€¢â€¢â€¢â€¢" 
                           maxlength="4"
                           onkeypress="if(event.key === 'Enter') checkAdminPassword()">
                </div>
                <div id="passwordError" class="text-rose-600 text-sm text-center hidden">
                    âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤
                </div>
                <div class="flex gap-3">
                    <button onclick="checkAdminPassword()" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-all">
                        í™•ì¸
                    </button>
                    <button onclick="closePasswordModal()" class="px-6 bg-slate-200 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-300 transition-all">
                        ì·¨ì†Œ
                    </button>
                </div>
                <div class="text-xs text-slate-400 text-center pt-2">
                    ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: 0000
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content p-8 max-w-sm text-center">
            <div class="mb-4 text-amber-500">
                <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">ì‚­ì œ í™•ì¸</h3>
            <p id="confirmMessage" class="text-slate-600 mb-6 font-medium">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex gap-3">
                <button onclick="executePendingDelete()" class="flex-1 bg-rose-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-rose-700 transition-all shadow-lg active:scale-95">ì‚­ì œ</button>
                <button onclick="closeConfirmModal()" class="flex-1 bg-slate-200 text-slate-700 px-4 py-3 rounded-xl font-bold hover:bg-slate-300 transition-all">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- Delete All Auth Modal -->
    <div id="deleteAllModal" class="modal">
        <div class="modal-content p-8" style="max-width: 400px;">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </div>
                <h3 class="text-2xl font-bold text-slate-800">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</h3>
                <p class="text-sm text-slate-500 mt-2">ì‚­ì œ ë¹„ë°€ë²ˆí˜¸(0001)ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="deleteAllPassword" class="w-full px-4 py-3 border-2 border-rose-200 rounded-xl focus:ring-2 focus:ring-rose-500 outline-none text-center text-lg tracking-widest font-mono" placeholder="â€¢â€¢â€¢â€¢" maxlength="4">
                <button onclick="checkDeleteAll()" class="w-full bg-rose-600 text-white font-bold py-3 rounded-xl hover:bg-rose-700 transition-all shadow-lg">í™•ì¸ ë° ì‚­ì œ</button>
                <button onclick="closeDeleteAllModal()" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200 transition-all">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content p-8 max-w-sm text-center">
            <div class="mb-4 text-indigo-600">
                <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">ì•Œë¦¼</h3>
            <p id="alertMessage" class="text-slate-600 mb-6 font-medium whitespace-pre-wrap"></p>
            <button onclick="closeAlertModal()" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg active:scale-95">í™•ì¸</button>
        </div>
    </div>

    <!-- Web Worker Script -->
    <script id="worker-script" type="javascript/worker">
        // ... existing worker code ...
        const ALIAS_MAP = {
            "ìŠ¤í…Œì¸ë¦¬ìŠ¤": "STS", "ìŠ¤í…": "STS", "SUS": "STS", "SU": "STS",
            "ë°°ê´€ìš©íƒ„ì†Œê°•ê´€(ë¬´ìš©ì ‘)": "ë°°ê´€ìš©íƒ„ì†Œê°•ê´€",
            "ë°°ê´€ìš©íƒ„ì†Œê°•ê´€(SPP)ìš©ì ‘ì‹": "ë°°ê´€ìš©íƒ„ì†Œê°•ê´€",
            "ë°°ê´€ìš©íƒ„ì†Œê°•ê´€(SPP)ë‚˜ì‚¬ì‹": "ë°°ê´€ìš©íƒ„ì†Œê°•ê´€",
            "PIPE": "íŒŒì´í”„", "ìŠ¬ë¦¬ë¸Œ": "ìŠ¤ë¦¬ë¸Œ", "í›„ë Œì§€": "í”Œëœì§€", "í›„ëœì§€": "í”Œëœì§€",
            "ì—˜ë³´": "ELBOW", "ì—˜ë³´ìš°": "ELBOW", "ì¹´í”Œë§": "ì»¤í”Œë§", "ì»¤í’€ë§": "ì»¤í”Œë§",
            "ë•íŠ¸": "DUCT", "ë‹¥íŠ¸": "ë•íŠ¸", "íŒí”„": "PUMP",
            "ë ˆë“€ìƒ¤": "ë¦¬ë“€ì„œ", "ë ˆë“€ì„œ": "ë¦¬ë“€ì„œ", "í‹°": "TEE", "í‹°ì´": "TEE",
            "ìŠ¤íŠ¸ë ˆì´ë‚˜": "ìŠ¤íŠ¸ë ˆë‚˜", "ìŠ¤íŠ¸ë ˆì´ë„ˆ": "ìŠ¤íŠ¸ë ˆë‚˜",
            "ì¹¼ë¼í•¨ì„": "ì¹¼ë¼í•¨ì„ë§ˆê°", "í•¨ì„ë§ˆê°": "ì¹¼ë¼í•¨ì„ë§ˆê°",
            "ê³ ë¬´ë°œí¬+ë§¤ì§": "ê³ ë¬´ë°œí¬", "ê³ ë¬´ë°œí¬ë³´ì˜¨ì¬": "ê³ ë¬´ë°œí¬", "ë§¤ì§í…Œì´í”„": "ë§¤ì§",
            "Y-T": "YT", "BRANCH": "ë¸Œëœì¹˜", "ê²½ì§ˆì—¼í™”ë¹„ë‹": "PVC",
            "P.V.C": "PVC", "ê²½ì§ˆì—¼í™”ë¹„ë‹ê´€": "PVCê´€", "ë‚´ì—´ì„±í´ë¦¬ì—¼í™”ë¹„ë‹": "CPVC",
            "C-PVC": "CPVC", "ë‚œì—°": "ì•„í‹°ë¡ ", "ê´€ë³´ì˜¨": "ì•„í‹°ë¡ ", "ë°œí¬í´ë¦¬ì—í‹¸ë Œ": "ë°œí¬",
            "ê³ ë¬´ë°œí¬": "ë°œí¬", "ê°€êµë°œí¬": "ë°œí¬", "ì€ë°•": "ë§¤ì§", "í…Œí”„": "í…Œì´í”„",
            "í–‰ê±°": "í–‰ê°€", "ë‹¬ëŒ€": "ì „ì‚°", "S#": "SCH", "GATE": "ê²Œì´íŠ¸", 
            "ë³´ì˜¨ì¬": "ë³´ì˜¨", "ë¶“ì‹±": "ë¶€ì‹±", "ë‹›ë¿”": "ë‹ˆí”Œ", "ë‹ˆë¿”": "ë‹ˆí”Œ", 
            "ë‹›ì ": "ë‹ˆí”Œ", "ë‹ˆì ": "ë‹ˆí”Œ", "ë‹›í”Œ": "ë‹ˆí”Œ", "U": "ìœ ",
            "BLACK": "ë¸”ë™", "ì–´ëŒ‘íƒ€": "ì–´ëŒ‘í„°", "SENSOR": "ì„¼ì„œ", "ë©”ê¾¸ë¼": "ìº¡", "BAND": "ë°´ë“œ",
            "ë“œë ˆì¸": "ë°°ìˆ˜", "WHC": "ìˆ˜ê²©ë°©ì§€ê¸°", "W.H.C": "ìˆ˜ê²©ë°©ì§€ê¸°"
        };

        const REMOVE_KEYWORDS = ["í¬í•¨", "ì—ì„œ", "(", ")", "+", "=", "-", ",", " "];

        function normalize(str) {
            if (!str) return "";
            let n = str.toString().toUpperCase().replace(/\s+/g, "");
            n = n.replace(/\*|X/g, "x");
            const sortedKeys = Object.keys(ALIAS_MAP).sort((a, b) => b.length - a.length);
            for (const key of sortedKeys) {
                if (n.includes(key)) n = n.split(key).join(ALIAS_MAP[key]);
            }
            REMOVE_KEYWORDS.forEach(kw => { n = n.split(kw).join(""); });
            n = n.replace(/EA|EACH|ê°œ|SET|ì„¸íŠ¸|BOX|ë°•ìŠ¤|M|MTR/g, "");
            return n.replace(/[^A-Z0-9ê°€-í£]/g, "");
        }

        function getSimilarity(s1, s2) {
            if (!s1 || !s2) return 0;
            if (s1 === s2) return 100;
            const getPairs = (str) => {
                const pairs = new Set();
                for (let i = 0; i < str.length - 1; i++) pairs.add(str.substring(i, i + 2));
                return pairs;
            };
            const pairs1 = getPairs(s1);
            const pairs2 = getPairs(s2);
            if (pairs1.size === 0 || pairs2.size === 0) return 0;
            let intersection = 0;
            pairs1.forEach(p => { if (pairs2.has(p)) intersection++; });
            return (2.0 * intersection) / (pairs1.size + pairs2.size) * 100;
        }

        self.onmessage = function(e) {
            const { csvRows, dbRows, config } = e.data;
            const results = [];
            const THRESHOLD = 45;

            const processedDB = dbRows.map(row => ({
                original: row,
                combined: normalize(row.A + row.B),
                normName: normalize(row.A),
                normSpec: normalize(row.B),
                normUnit: normalize(row.C),
                totalCost: (parseFloat(row.D) || 0) + (parseFloat(row.E) || 0)
            }));

            for (let i = 0; i < csvRows.length; i++) {
                const row = csvRows[i];
                const srcName = row[config.nameIdx] || "";
                const srcSpec = row[config.specIdx] || "";
                const srcUnit = row[config.unitIdx] || "";
                
                const rawMat = row[config.matIdx];
                const rawLab = row[config.labIdx];
                const numMat = parseFloat(String(rawMat || "0").replace(/[^0-9.]/g, ""));
                const numLab = parseFloat(String(rawLab || "0").replace(/[^0-9.]/g, ""));
                
                if (numMat > 0 || numLab > 0) {
                    results.push([srcName, srcSpec, srcUnit, rawMat, rawLab, "-", "-", "-", "-", "-", "-", "-", "-", "-", "-"]);
                    continue;
                }

                const nCombined = normalize(srcName + srcSpec);
                const nUnit = normalize(srcUnit);
                const nName = normalize(srcName);
                const nSpec = normalize(srcSpec);

                if (!nCombined) {
                    results.push([srcName, srcSpec, srcUnit, 0, 0, "", "", "", "", "", "", "", "", "", ""]);
                    continue;
                }

                const identicalMatches = processedDB.filter(db => db.combined === nCombined && (db.normUnit === nUnit || !nUnit));

                if (identicalMatches.length > 0) {
                    const uniquePrices = new Set(identicalMatches.map(m => m.original.D + "|" + m.original.E));
                    
                    if (uniquePrices.size > 1) {
                        identicalMatches.sort((a, b) => b.totalCost - a.totalCost);
                        const maxItem = identicalMatches[0].original;
                        const minItem = identicalMatches[identicalMatches.length - 1].original;
                        results.push([
                            srcName, srcSpec, srcUnit, "ì¶©ëŒ!", "ì½”ë“œë¥¼í™•ì¸í•˜ì„¸ìš”.",
                            maxItem.A, maxItem.B, maxItem.C, maxItem.D, maxItem.E,
                            minItem.A, minItem.B, minItem.C, minItem.D, minItem.E 
                        ]);
                    } else {
                        const best = identicalMatches[0].original;
                        results.push([
                            srcName, srcSpec, srcUnit, best.D, best.E,
                            "", "", "", "ìë™ë§¤ì¹­", "",
                            "", "", "", "", ""
                        ]);
                    }
                } else {
                    let candidates = [];
                    for (let j = 0; j < processedDB.length; j++) {
                        const db = processedDB[j];
                        const nameSim = getSimilarity(nName, db.normName);
                        const specSim = getSimilarity(nSpec, db.normSpec);
                        const unitSim = (nUnit === db.normUnit && nUnit !== "") ? 100 : 0;
                        const totalScore = (nameSim * 0.5) + (specSim * 0.4) + (unitSim * 0.1);
                        
                        if (totalScore >= THRESHOLD) {
                            candidates.push({ score: totalScore, item: db.original });
                        }
                    }

                    candidates.sort((a, b) => b.score - a.score);
                    const c1 = candidates[0] ? candidates[0].item : {};
                    const c2 = candidates[1] ? candidates[1].item : {};

                    results.push([
                        srcName, srcSpec, srcUnit, 0, 0,
                        c1.A || "", c1.B || "", c1.C || "", c1.D || "", c1.E || "",
                        c2.A || "", c2.B || "", c2.C || "", c2.D || "", c2.E || ""
                    ]);
                }

                if (i % 50 === 0 || i === csvRows.length - 1) {
                    self.postMessage({ type: 'PROGRESS', percent: Math.floor(((i + 1) / csvRows.length) * 100) });
                }
            }
            self.postMessage({ type: 'COMPLETE', results });
        };
    </script>

    <script>
        // Custom Alert Logic
        function customAlert(msg) {
            const message = typeof msg === 'string' ? msg : JSON.stringify(msg);
            document.getElementById('alertMessage').textContent = message.replace(/\\n/g, '\n');
            document.getElementById('alertModal').classList.add('active');
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('active');
        }
        
        window.alert = customAlert;

        // Global Variables
        let dbRows = [];
        let csvRows = [];
        let resultRows = [];
        let colConfig = { nameIdx: 0, specIdx: 1, unitIdx: 2, matIdx: 3, labIdx: 4 };
        let localDB = JSON.parse(localStorage.getItem('samjin_local_db')) || [];
        let n8nConfig = JSON.parse(localStorage.getItem('samjin_n8n_config')) || {
            webhookAdd: '',
            webhookUpdate: '',
            webhookDelete: '',
            sheetsId: '1GaUzextj8jdry2iegBK7EiWDm1VASX8od3o9tP7DoZU',
            autoSync: false
        };
        
        // Admin password
        let adminPassword = localStorage.getItem('samjin_admin_password') || '0000';
        let isAdminAuthenticated = false;
        let pendingTab = null;
        let pendingDeleteIdx = null;

        // DOM Elements
        const logEl = document.getElementById("log");
        const matchBtn = document.getElementById("matchBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const dbStatusText = document.getElementById("dbStatusText");
        const dbStatusBadge = document.getElementById("dbStatusBadge");
        const progressBar = document.getElementById("progressBar");
        const progressContainer = document.getElementById("progressContainer");
        const fileNameDisplay = document.getElementById("fileNameDisplay");

        // Tab Switching
        function switchTab(tabName) {
            if (tabName === 'n8n-config' && !isAdminAuthenticated) {
                pendingTab = tabName;
                openPasswordModal();
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => {
                if(btn.getAttribute('onclick').includes(tabName)) btn.classList.add('active');
            });

            if (tabName === 'db-manager') {
                renderDBTable();
            } else if (tabName === 'n8n-config') {
                loadN8nConfig();
            }
        }

        // ... existing modal functions ...
        function openPasswordModal() {
            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('adminPassword').value = '';
            document.getElementById('passwordError').classList.add('hidden');
            setTimeout(() => { document.getElementById('adminPassword').focus(); }, 100);
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
            document.getElementById('adminPassword').value = '';
            document.getElementById('passwordError').classList.add('hidden');
            pendingTab = null;
        }

        function checkAdminPassword() {
            const inputPassword = document.getElementById('adminPassword').value;
            if (inputPassword === adminPassword) {
                isAdminAuthenticated = true;
                closePasswordModal();
                if (pendingTab) {
                    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.getElementById(`tab-${pendingTab}`).classList.remove('hidden');
                    const buttons = document.querySelectorAll('.tab-button');
                    buttons.forEach(btn => {
                        if(btn.getAttribute('onclick').includes(pendingTab)) btn.classList.add('active');
                    });
                    loadN8nConfig();
                    addLog('ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ', 'success');
                }
            } else {
                document.getElementById('passwordError').classList.remove('hidden');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        function changeAdminPassword(newPassword) {
            if (newPassword && newPassword.length === 4) {
                adminPassword = newPassword;
                localStorage.setItem('samjin_admin_password', newPassword);
                addLog('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                return true;
            }
            return false;
        }

        // Logging
        function addLog(msg, type='info') {
            const time = new Date().toLocaleTimeString('ko-KR', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
            let colorClass = "text-indigo-300";
            let symbol = "Â»";
            if (type === 'success') { colorClass = "text-emerald-400"; symbol = "âœ“"; }
            if (type === 'error') { colorClass = "text-rose-400"; symbol = "âœ—"; }
            if (type === 'warn') { colorClass = "text-amber-400"; symbol = "âš "; }
            const div = document.createElement('div');
            div.className = `mb-1.5 flex items-start gap-3 opacity-0 translate-x-[-10px]`;
            div.style.animation = "slideIn 0.3s forwards";
            div.innerHTML = `
                <span class="text-slate-600 shrink-0 text-[10px] mt-0.5">${time}</span>
                <span class="${colorClass} shrink-0">${symbol}</span>
                <span class="${colorClass} break-all">${msg}</span>
            `;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }
        const style = document.createElement('style');
        style.textContent = `@keyframes slideIn { to { opacity: 1; transform: translateX(0); } }`;
        document.head.appendChild(style);
        function clearLog() { logEl.innerHTML = ""; addLog("í„°ë¯¸ë„ ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); }

        // Utility
        function parsePrice(val) {
            if (val === null || val === undefined || val === "") return "0";
            const clean = String(val).replace(/[^0-9.]/g, "");
            return clean === "" ? "0" : clean;
        }
        function getValueByKeywords(obj, keywords) {
            const keys = Object.keys(obj);
            const foundKey = keys.find(k => {
                const cleanK = k.toString().replace(/\s+/g, "");
                return keywords.some(kw => cleanK.includes(kw));
            });
            return foundKey ? obj[foundKey] : null;
        }

        // DB Management
        async function fetchDB() {
            const sheetName = document.getElementById("sheetSelect").value;
            const SPREADSHEET_ID = n8nConfig.sheetsId;
            const DB_URL = `https://opensheet.elk.sh/${SPREADSHEET_ID}/${encodeURIComponent(sheetName)}`;
            
            dbStatusBadge.textContent = "SYNCING";
            dbStatusBadge.className = "px-2 py-1 rounded text-[10px] font-bold bg-indigo-500 text-white animate-pulse";
            dbStatusText.innerHTML = `<span class="w-2 h-2 bg-indigo-500 rounded-full mr-2 animate-ping"></span>${sheetName} ë°ì´í„° ë™ê¸°í™” ì¤‘...`;
            dbStatusText.className = "text-xs text-indigo-500 font-bold";
            
            try {
                const res = await fetch(DB_URL);
                if (!res.ok) throw new Error('Network response was not ok');
                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) throw new Error("ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");

                dbRows = data.map(r => ({
                    A: getValueByKeywords(r, ["í’ˆëª…", "í’ˆëª©", "ì´ë¦„"]) || "",
                    B: getValueByKeywords(r, ["ê·œê²©", "ì‚¬ì´ì¦ˆ", "ê·œ ê²©"]) || "",
                    C: getValueByKeywords(r, ["ë‹¨ìœ„", "ë‹¨ ìœ„"]) || "",
                    D: parsePrice(getValueByKeywords(r, ["ì¬ë£Œë¹„", "ì¬ë£Œ", "ë‹¨ê°€", "ìì¬ë¹„"])),
                    E: parsePrice(getValueByKeywords(r, ["ë…¸ë¬´ë¹„", "ë…¸ë¬´"]))
                }));

                localDB.forEach(local => {
                    const exists = dbRows.find(db => db.A === local.A && db.B === local.B);
                    if (!exists) dbRows.push(local);
                });

                dbStatusBadge.textContent = "CONNECTED";
                dbStatusBadge.className = "px-2 py-1 rounded text-[10px] font-bold bg-emerald-500 text-white";
                dbStatusText.innerHTML = `<span class="w-2 h-2 bg-emerald-500 rounded-full mr-2"></span>DB v6.0 ì—°ê²°ë¨`;
                dbStatusText.className = "text-xs text-emerald-600 font-bold";
                addLog(`Master DB ë¡œë“œ ì™„ë£Œ: [${sheetName}] + ë¡œì»¬ DB ë³‘í•©`, 'success');
                if(csvRows.length > 0) matchBtn.disabled = false;
            } catch (err) {
                dbStatusBadge.textContent = "ERROR";
                dbStatusBadge.className = "px-2 py-1 rounded text-[10px] font-bold bg-rose-500 text-white";
                dbStatusText.textContent = "âŒ ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨ (ë¡œì»¬ DB ì‚¬ìš© ì¤‘)";
                dbStatusText.className = "text-xs text-rose-500 font-bold";
                addLog("DB ë¡œë”© ì—ëŸ¬: " + err.message + " (ë¡œì»¬ DB ì‚¬ìš©)", 'error');
                dbRows = [...localDB];
            }
        }

        // ... existing renderDBTable, updateDBItem, deleteDBItem ...
        function renderDBTable() {
            const tbody = document.getElementById('dbTableBody');
            tbody.innerHTML = '';
            const searchTerm = document.getElementById('searchDB').value.toLowerCase();
            let filteredDB = localDB;
            if (searchTerm) {
                filteredDB = filteredDB.filter(item => item.A.toLowerCase().includes(searchTerm) || item.B.toLowerCase().includes(searchTerm));
            }
            filteredDB.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-slate-600 font-mono">${idx + 1}</td>
                    <td><input type="text" value="${item.A}" onchange="updateDBItem(${idx}, 'A', this.value)"></td>
                    <td><input type="text" value="${item.B}" onchange="updateDBItem(${idx}, 'B', this.value)"></td>
                    <td><input type="text" value="${item.C}" onchange="updateDBItem(${idx}, 'C', this.value)"></td>
                    <td><input type="number" value="${item.D}" onchange="updateDBItem(${idx}, 'D', this.value)"></td>
                    <td><input type="number" value="${item.E}" onchange="updateDBItem(${idx}, 'E', this.value)"></td>
                    <td><button onclick="openConfirmDelete(${idx})" class="text-rose-600 hover:text-rose-800 font-semibold">ì‚­ì œ</button></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('dbCount').textContent = localDB.length;
        }
        function updateDBItem(idx, field, value) {
            localDB[idx][field] = value;
            localStorage.setItem('samjin_local_db', JSON.stringify(localDB));
            addLog(`í’ˆëª© ìˆ˜ì •: ${localDB[idx].A}`, 'success');
            if (n8nConfig.autoSync && n8nConfig.webhookUpdate) sendToN8n(n8nConfig.webhookUpdate, localDB[idx], 'update');
        }
        
        // Revised Delete Item Logic
        function openConfirmDelete(idx) {
            pendingDeleteIdx = idx;
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            pendingDeleteIdx = null;
        }

        function executePendingDelete() {
            if (pendingDeleteIdx === null) return;
            
            const deletedItem = localDB[pendingDeleteIdx];
            localDB.splice(pendingDeleteIdx, 1);
            localStorage.setItem('samjin_local_db', JSON.stringify(localDB));
            renderDBTable();
            addLog(`í’ˆëª© ì‚­ì œ: ${deletedItem.A}`, 'warn');
            if (n8nConfig.autoSync && n8nConfig.webhookDelete) sendToN8n(n8nConfig.webhookDelete, deletedItem, 'delete');
            
            closeConfirmModal();
        }

        // ... existing modal actions ...
        function openAddItemModal() { document.getElementById('addItemModal').classList.add('active'); }
        function closeAddItemModal() {
            document.getElementById('addItemModal').classList.remove('active');
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemSpec').value = '';
            document.getElementById('newItemUnit').value = '';
            document.getElementById('newItemMat').value = '';
            document.getElementById('newItemLab').value = '';
        }
        function addNewItem() {
            const name = document.getElementById('newItemName').value.trim();
            const spec = document.getElementById('newItemSpec').value.trim();
            const unit = document.getElementById('newItemUnit').value.trim();
            const mat = document.getElementById('newItemMat').value || '0';
            const lab = document.getElementById('newItemLab').value || '0';
            if (!name || !spec || !unit) { customAlert('í’ˆëª…, ê·œê²©, ë‹¨ìœ„ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.'); return; }
            const newItem = { A: name, B: spec, C: unit, D: mat, E: lab };
            localDB.push(newItem);
            localStorage.setItem('samjin_local_db', JSON.stringify(localDB));
            closeAddItemModal();
            renderDBTable();
            addLog(`ìƒˆ í’ˆëª© ì¶”ê°€: ${name} (${spec})`, 'success');
            if (n8nConfig.autoSync && n8nConfig.webhookAdd) sendToN8n(n8nConfig.webhookAdd, newItem, 'add');
        }
        
        // Revised Delete All Logic
        function openDeleteAllModal() {
            if (localDB.length === 0) {
                customAlert("ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            document.getElementById('deleteAllPassword').value = '';
            document.getElementById('deleteAllModal').classList.add('active');
            setTimeout(() => { document.getElementById('deleteAllPassword').focus(); }, 100);
        }

        function closeDeleteAllModal() {
            document.getElementById('deleteAllModal').classList.remove('active');
            document.getElementById('deleteAllPassword').value = '';
        }

        function checkDeleteAll() {
            const pwd = document.getElementById('deleteAllPassword').value;
            if (pwd === "0001") {
                const count = localDB.length;
                localDB = [];
                localStorage.setItem('samjin_local_db', JSON.stringify(localDB));
                renderDBTable();
                addLog(`DB ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ: ${count}ê°œ í•­ëª© ì‚­ì œë¨`, 'warn');
                closeDeleteAllModal();
                customAlert("ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                customAlert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                document.getElementById('deleteAllPassword').value = '';
                document.getElementById('deleteAllPassword').focus();
            }
        }

        // ... existing n8n logic ...
        async function sendToN8n(webhookUrl, data, action) {
            if (!webhookUrl) return;
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action, timestamp: new Date().toISOString(), data: { í’ˆëª…: data.A, ê·œê²©: data.B, ë‹¨ìœ„: data.C, ì¬ë£Œë¹„: data.D, ë…¸ë¬´ë¹„: data.E } })
                });
                if (response.ok) addLog(`n8n ë™ê¸°í™” ì„±ê³µ: ${action} - ${data.A}`, 'success');
                else addLog(`n8n ë™ê¸°í™” ì‹¤íŒ¨: ${response.statusText}`, 'error');
            } catch (err) { addLog(`n8n ì—°ë™ ì˜¤ë¥˜: ${err.message}`, 'error'); }
        }

        function loadN8nConfig() {
            document.getElementById('n8nWebhookAdd').value = n8nConfig.webhookAdd || '';
            document.getElementById('n8nWebhookUpdate').value = n8nConfig.webhookUpdate || '';
            document.getElementById('n8nWebhookDelete').value = n8nConfig.webhookDelete || '';
            document.getElementById('googleSheetsId').value = n8nConfig.sheetsId || '';
            document.getElementById('enableAutoSync').checked = n8nConfig.autoSync || false;
        }
        function changePasswordClick() {
            const newPassword = document.getElementById('newAdminPassword').value.trim();
            if (!newPassword) { customAlert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (newPassword.length !== 4) { customAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (changeAdminPassword(newPassword)) {
                customAlert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!\nìƒˆ ë¹„ë°€ë²ˆí˜¸: ' + newPassword);
                document.getElementById('newAdminPassword').value = '';
            } else { customAlert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        }
        function saveN8nConfig() {
            n8nConfig = {
                webhookAdd: document.getElementById('n8nWebhookAdd').value.trim(),
                webhookUpdate: document.getElementById('n8nWebhookUpdate').value.trim(),
                webhookDelete: document.getElementById('n8nWebhookDelete').value.trim(),
                sheetsId: document.getElementById('googleSheetsId').value.trim(),
                autoSync: document.getElementById('enableAutoSync').checked
            };
            localStorage.setItem('samjin_n8n_config', JSON.stringify(n8nConfig));
            addLog('n8n ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            customAlert('n8n ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        function exportDBToExcel() {
            const ws = XLSX.utils.json_to_sheet(localDB.map(item => ({ 'í’ˆëª…': item.A, 'ê·œê²©': item.B, 'ë‹¨ìœ„': item.C, 'ì¬ë£Œë¹„': item.D, 'ë…¸ë¬´ë¹„': item.E })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DB");
            XLSX.writeFile(wb, `SAMJIN_DB_${new Date().toISOString().slice(0,10)}.xlsx`);
            addLog('DB ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
        }
        function importDBFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    if (jsonData.length < 2) { customAlert('íŒŒì¼ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
                    let importCount = 0;
                    let skipCount = 0;
                    const startRow = (String(jsonData[0][0]).includes('í’ˆëª…') || String(jsonData[0][0]).includes('ì´ë¦„')) ? 1 : 0;
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const itemName = row[0] ? String(row[0]).trim() : "";
                        const itemSpec = row[1] ? String(row[1]).trim() : "";
                        const itemUnit = row[2] ? String(row[2]).trim() : "";
                        const itemMat = row[3] ? String(row[3]).replace(/[^0-9.]/g, '') : "0";
                        const itemLab = row[4] ? String(row[4]).replace(/[^0-9.]/g, '') : "0";
                        if (!itemName) { skipCount++; continue; }
                        const isDuplicate = localDB.some(item => item.A === itemName && item.B === itemSpec);
                        if (isDuplicate) { skipCount++; continue; }
                        const newItem = { A: itemName, B: itemSpec, C: itemUnit, D: itemMat, E: itemLab };
                        localDB.push(newItem);
                        importCount++;
                        if (n8nConfig.autoSync && n8nConfig.webhookAdd) sendToN8n(n8nConfig.webhookAdd, newItem, 'import');
                    }
                    localStorage.setItem('samjin_local_db', JSON.stringify(localDB));
                    renderDBTable();
                    customAlert(`ì—‘ì…€ ì—…ë¡œë“œ ì™„ë£Œ!\nì¶”ê°€: ${importCount}ê±´\nìŠ¤í‚µ: ${skipCount}ê±´`);
                    addLog(`DB ì—‘ì…€ ì—…ë¡œë“œ ì™„ë£Œ: ${importCount}ê±´ ì¶”ê°€, ${skipCount}ê±´ ìŠ¤í‚µ`, 'success');
                    event.target.value = '';
                } catch (err) {
                    console.error(err);
                    customAlert('ì—‘ì…€ íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                    addLog('DB ì—‘ì…€ ì—…ë¡œë“œ ì˜¤ë¥˜: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // File Upload (Main Matching)
        document.getElementById("excelFile").addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            fileNameDisplay.textContent = file.name;
            fileNameDisplay.classList.add("text-blue-600", "font-bold");
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    csvRows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    if (csvRows.length < 2) throw new Error("íŒŒì¼ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    const header = csvRows[0].map(h => String(h || "").replace(/\s+/g, ""));
                    const findIdx = (kws) => {
                        const idx = header.findIndex(h => kws.some(kw => h.includes(kw)));
                        return idx === -1 ? 0 : idx;
                    };
                    colConfig.nameIdx = findIdx(["í’ˆëª…", "í’ˆëª©", "í•­ëª©", "ë‚´ì—­"]);
                    colConfig.specIdx = findIdx(["ê·œê²©", "ì‚¬ì´ì¦ˆ", "ì¹˜ìˆ˜"]);
                    colConfig.unitIdx = findIdx(["ë‹¨ìœ„"]);
                    colConfig.matIdx = findIdx(["ì¬ë£Œë¹„", "ìì¬ë¹„", "ë‹¨ê°€"]);
                    colConfig.labIdx = findIdx(["ë…¸ë¬´ë¹„", "ì¸ê±´ë¹„"]);
                    addLog(`ë‚´ì—­ì„œ ë¡œë“œ ì™„ë£Œ: ${file.name} (ì´ ${csvRows.length - 1}ê°œ í–‰ ê°ì§€ë¨)`, 'success');
                    if(dbRows.length > 0) matchBtn.disabled = false;
                } catch (err) { 
                    addLog("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: " + err.message, 'error'); 
                    fileNameDisplay.textContent = "íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.";
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Worker Match
        function startWorkerMatch() {
            if (csvRows.length < 2) return;
            matchBtn.disabled = true;
            downloadBtn.disabled = true;
            matchBtn.classList.add('matching-active');
            progressContainer.classList.remove('hidden');
            addLog(`í•™ìŠµëœ ë§¤ì¹­ ì—”ì§„ ê°€ë™... (${csvRows.length - 1}ê±´ ì²˜ë¦¬ ì‹œì‘)`, 'warn');
            const blob = new Blob([document.getElementById('worker-script').textContent], { type: "text/javascript" });
            const worker = new Worker(URL.createObjectURL(blob));
            worker.postMessage({ csvRows: csvRows.slice(1), dbRows: dbRows, config: colConfig });
            worker.onmessage = function(e) {
                if (e.data.type === 'PROGRESS') {
                    const p = e.data.percent;
                    progressBar.style.width = p + "%";
                    document.getElementById("matchBtnText").textContent = `ì²˜ë¦¬ ì¤‘... ${p}%`;
                } else if (e.data.type === 'COMPLETE') {
                    resultRows = e.data.results;
                    const conflicts = resultRows.filter(r => r[3] === "[ì¶©ëŒ]").length;
                    const autoMatched = resultRows.filter(r => r[8] === "ìë™ë§¤ì¹­").length;
                    addLog(`ë§¤ì¹­ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!`, 'success');
                    addLog(`ìë™ ë§¤ì¹­: ${autoMatched}ê±´ / ë‹¨ê°€ ì¶©ëŒ: ${conflicts}ê±´ ê°ì§€ë¨`, 'info');
                    matchBtn.disabled = false;
                    matchBtn.classList.remove('matching-active');
                    document.getElementById("matchBtnText").textContent = "âš¡ ê³ ì† ë§¤ì¹­ ì‹¤í–‰";
                    downloadBtn.disabled = false;
                    setTimeout(() => {
                        progressContainer.classList.add('hidden');
                        progressBar.style.width = "0%";
                    }, 2000);
                    worker.terminate();
                }
            };
            worker.onerror = function(err) {
                addLog("ë§¤ì¹­ ì—”ì§„ ì˜¤ë¥˜: " + err.message, 'error');
                matchBtn.disabled = false;
                matchBtn.classList.remove('matching-active');
                worker.terminate();
            };
        }
        function downloadExcel() {
            if (resultRows.length === 0) return;
            try {
                const header = ["ê³µ_í’ˆëª…", "ê³µ_ê·œê²©", "ê³µ_ë‹¨ìœ„", "M_ì¬ë£Œë¹„", "M_ë…¸ë¬´ë¹„", "ì½”ë“œ1_í’ˆëª…", "ì½”ë“œ1_ê·œê²©", "ì½”ë“œ1_ë‹¨ìœ„", "ì¬ë£Œë¹„", "ë…¸ë¬´ë¹„", "ì½”ë“œ2_í’ˆëª…", "ì½”ë“œ2_ê·œê²©", "ì½”ë“œ2_ë‹¨ìœ„", "ì¬ë£Œë¹„", "ë…¸ë¬´ë¹„"];
                const ws = XLSX.utils.aoa_to_sheet([header, ...resultRows]);
                const wscols = [{wch: 25}, {wch: 20}, {wch: 8}, {wch: 15}, {wch: 15}, {wch: 25}, {wch: 20}, {wch: 8}, {wch: 15}, {wch: 15}, {wch: 25}, {wch: 20}, {wch: 8}, {wch: 15}, {wch: 15}];
                ws['!cols'] = wscols;
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ë§¤ì¹­ê²°ê³¼");
                const fileName = `ë§¤ì¹­ê²°ê³¼_${new Date().toISOString().slice(0,10)}_${Math.floor(Math.random()*1000)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                addLog(`ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${fileName}`, 'success');
            } catch (err) { addLog("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message, 'error'); }
        }

        // Event Listeners
        document.getElementById("sheetSelect").addEventListener("change", fetchDB);
        document.getElementById("searchDB")?.addEventListener("input", renderDBTable);
        document.getElementById("filterCategory")?.addEventListener("change", renderDBTable);

        // ========== PUMSUM CALCULATOR FUNCTIONALITY (Pro v3.5 Logic) ==========
        let pumsumMasterDB = [];
        let pumsumFinalOutput = [];

        // í…ìŠ¤íŠ¸ ì •ê·œí™” ìœ í‹¸ë¦¬í‹°
        const clean = (s) => String(s || "").toLowerCase().replace(/[^a-z0-9ê°€-í£Ã¸]/g, "");

        // ì‰¼í‘œ ì œê±° (ìˆ«ì ì‚¬ì´ì˜ ì‰¼í‘œë§Œ)
        const normalizeNumbers = (s) => {
            if (!s) return "";
            return String(s).replace(/(\d),(?=\d{3})/g, '$1');
        };

        // ê·œê²© ìˆ˜ì¹˜ ë¶„ì„
        const parseSpec = (s) => {
            if (!s) return [];
            const results = [];
            const cleanS = normalizeNumbers(s);
            const regex = /(\d+\.?\d*)\s*([a-zê°€-í£%Ã¸]+)|([a-zê°€-í£%Ã¸]+)\s*(\d+\.?\d*)/gi;
            let m;
            while ((m = regex.exec(cleanS)) !== null) {
                let v = parseFloat(m[1] || m[4]);
                let u = (m[2] || m[3]).toLowerCase();
                results.push({ val: v, unit: u });
            }
            return results;
        };

        // ë²”ìœ„(~) ë§¤ì¹­ ì²´í¬
        const checkRange = (val, dbSpec) => {
            if (!dbSpec.includes('~')) return false;
            const cleanDbSpec = normalizeNumbers(dbSpec);
            const parts = cleanDbSpec.split('~');
            const minM = parts[0].match(/(\d+\.?\d*)/);
            const maxM = parts[1].match(/(\d+\.?\d*)/);
            if (minM && maxM) {
                const min = parseFloat(minM[1]);
                const max = parseFloat(maxM[1]);
                return val >= min && val <= max;
            }
            return false;
        };

        // ê·œê²© ë¹„êµ ë¡œì§ (Pro v3.5)
        const compareStrictPrecision = (userStr, dbSpecStr) => {
            const userPairs = parseSpec(userStr);
            const dbPairs = parseSpec(dbSpecStr);
            const isBelowCondition = dbSpecStr.includes("ì´í•˜");
            const hasRangeCondition = dbSpecStr.includes("~");

            if (dbPairs.length === 0) return { valid: true, specScore: 0 };

            let matchScore = 0;
            for (const dp of dbPairs) {
                const up = userPairs.find(x => x.unit === dp.unit);
                if (up) {
                    if (hasRangeCondition) {
                        if (checkRange(up.val, dbSpecStr)) {
                            matchScore++;
                            continue;
                        } else {
                            return { valid: false };
                        }
                    }

                    if (dp.unit === 't' || dp.unit === 'kg') {
                        if (up.val !== dp.val) return { valid: false };
                    } else if (dp.unit === 'd' || dp.unit === 'Ã¸') {
                        if (isBelowCondition) {
                            if (up.val > dp.val) return { valid: false };
                        } else {
                            if (up.val !== dp.val) return { valid: false };
                        }
                    } else {
                        if (up.val !== dp.val) return { valid: false };
                    }
                    matchScore++;
                } else {
                    return { valid: false };
                }
            }
            return { valid: true, specScore: matchScore };
        };

        async function syncPumsumData() {
            const status = document.getElementById('pumsumSyncStatus');
            const btn = document.getElementById('pumsumSyncBtn');
            try {
                btn.disabled = true;
                status.innerText = "â³ Pro v3.5: JSON ë°ì´í„° ë¡œë“œ ì¤‘...";
                const id = "1zQtfJZFsZ2PccBm4ul1JrOaKKOVN_FYmjV3GhJzYpJA";
                const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=Tableì¢…í•©`;
                const res = await fetch(url);
                const txt = await res.text();
                const json = JSON.parse(txt.substring(47).slice(0, -2));
                
                pumsumMasterDB = json.table.rows.map(r => {
                    const rowData = r.c;
                    return {
                        keywords: rowData.slice(0, 26).map(c => c && c.v ? String(c.v).trim() : "").filter(v => v !== ""),
                        code: rowData[26] ? rowData[26].v : "",
                        spec: rowData[27] ? String(rowData[27].v) : "",
                        extraData: rowData.slice(30, 38).map(c => c ? c.v : "")
                    };
                }).filter(d => d.keywords.length > 0 || d.code);

                status.innerText = `âœ… Pro v3.5 DB ì—°ê²°ë¨`;
                btn.innerHTML = "âœ”ï¸ ë™ê¸°í™” ì™„ë£Œ";
                btn.disabled = false;
                initPumsumTableHeader();
                addLog('Pro v3.5 í’ˆì…ˆ DB ë™ê¸°í™” ì™„ë£Œ', 'success');
            } catch (error) {
                btn.disabled = false;
                status.innerText = "âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
                addLog('í’ˆì…ˆ DB ë¡œë”© ì—ëŸ¬: ' + error.message, 'error');
            }
        }

        function initPumsumTableHeader() {
            const header = document.getElementById('pumsumTableHeader');
            header.innerHTML = `
                <tr class="bg-indigo-50 text-slate-700 font-bold uppercase text-[10px]">
                    <th class="px-3 py-3 border border-indigo-100">í’ˆëª…</th>
                    <th class="px-3 py-3 border border-indigo-100">ê·œê²©</th>
                    <th class="px-3 py-3 border border-indigo-100 text-center">ì ìˆ˜</th>
                    <th class="px-3 py-3 border border-indigo-100 bg-indigo-100 text-indigo-700">í’ˆì…ˆì½”ë“œ</th>
                    <th class="px-3 py-3 border border-indigo-100 bg-indigo-100 text-indigo-700">í’ˆì…ˆê·œê²©</th>
                    <th class="px-3 py-3 border border-indigo-100 text-center">ê³µì¢…</th>
                    <th class="px-3 py-3 border border-indigo-100 text-center">í’ˆì…ˆ(ì¸)</th>
                    <th class="px-3 py-3 border border-indigo-100 text-center">ê³µì¢…</th>
                    <th class="px-3 py-3 border border-indigo-100 text-center">í’ˆì…ˆ(ì¸)</th>
                </tr>
            `;
        }

        document.getElementById('pumsumFileInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (pumsumMasterDB.length === 0) { customAlert('ë¨¼ì € í’ˆì…ˆ DBë¥¼ ë™ê¸°í™”í•´ì£¼ì„¸ìš”.'); this.value = ''; return; }
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'});
                const sourceBill = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
                runPumsumMatching(sourceBill);
            };
            reader.readAsArrayBuffer(file);
        });

        async function runPumsumMatching(sourceBill) {
            document.getElementById('pumsumLoading').classList.replace('hidden', 'flex');
            document.getElementById('pumsumEmptyState').classList.add('hidden');
            document.getElementById('pumsumResultArea').classList.add('hidden');

            // ë Œë”ë§ ì§€ì—°ì„ ì¤˜ì„œ UI ì—…ë°ì´íŠ¸ ë³´ì¥
            await new Promise(r => setTimeout(r, 100));

            pumsumFinalOutput = JSON.parse(JSON.stringify(sourceBill));
            // í—¤ë” ì„¤ì • (v3.5 ê¸°ì¤€)
            if (pumsumFinalOutput[0]) {
                pumsumFinalOutput[0][4] = "í’ˆì…ˆì½”ë“œ";
                pumsumFinalOutput[0][5] = "í’ˆì…ˆê·œê²©";
                const headers = ["ê³µì¢…", "í’ˆì…ˆ(ì¸)", "ê³µì¢…", "í’ˆì…ˆ(ì¸)", "ê³µì¢…", "í’ˆì…ˆ(ì¸)", "ê³µì¢…", "í’ˆì…ˆ(ì¸)", "ì‹ ë¢°ë„"];
                for(let j=0; j<9; j++) pumsumFinalOutput[0][6 + j] = headers[j];
            }

            const excludeKeywords = ['ì—˜ë³´', 'í‹°ì´', 'ë ˆë“€ìƒ¤', 'ë¦¬ë“€ì„œ', 'ì†Œì¼“', 'ìœ ë‹ˆì˜¨', 'ì–´ëŒ‘í„°', 'ì•„ë‹µíƒ€', 'ì´ìŒì‡ ', 'ì´ìŒê´€', 'ì„œí¬íŠ¸'];
            let totalMatched = 0;

            for (let i = 1; i < pumsumFinalOutput.length; i++) {
                const row = pumsumFinalOutput[i];
                if (!row || !row[0]) continue;

                const itemName = String(row[0]).trim();
                const itemSpec = String(row[1] || "").trim();
                const userQty = parseFloat(normalizeNumbers(String(row[3]))) || 0;

                const searchBase = normalizeNumbers(itemName + " " + itemSpec).toLowerCase();
                let bestMatch = null;
                let currentMaxScore = -1;
                let bestSpecScore = -1;

                const hasExcludeKeyword = excludeKeywords.some(kw => itemName.includes(kw) || itemSpec.includes(kw));

                if (!hasExcludeKeyword) {
                    for (const dbEntry of pumsumMasterDB) {
                        let cellScore = 0;
                        dbEntry.keywords.forEach(kw => {
                            if (searchBase.includes(kw.toLowerCase())) cellScore++;
                        });

                        if (cellScore > 0 && cellScore >= currentMaxScore) {
                            const specCheck = compareStrictPrecision(itemSpec, dbEntry.spec);
                            if (specCheck.valid) {
                                if (cellScore > currentMaxScore || (cellScore === currentMaxScore && specCheck.specScore > bestSpecScore)) {
                                    currentMaxScore = cellScore;
                                    bestSpecScore = specCheck.specScore;
                                    bestMatch = dbEntry;
                                }
                            }
                        }
                    }
                }

                if (bestMatch) {
                    totalMatched++;
                    pumsumFinalOutput[i][4] = bestMatch.code;
                    pumsumFinalOutput[i][5] = bestMatch.spec;
                    pumsumFinalOutput[i][14] = currentMaxScore;
                    for (let j = 0; j < 8; j++) {
                        const dbVal = bestMatch.extraData[j];
                        const targetIdx = 6 + j;
                        if ([1, 3, 5, 7].includes(j)) {
                            const val = parseFloat(normalizeNumbers(String(dbVal))) || 0;
                            pumsumFinalOutput[i][targetIdx] = val * userQty;
                        } else {
                            pumsumFinalOutput[i][targetIdx] = dbVal;
                        }
                    }
                } else {
                    pumsumFinalOutput[i][4] = ""; pumsumFinalOutput[i][5] = ""; pumsumFinalOutput[i][14] = 0;
                    for (let j = 0; j < 8; j++) pumsumFinalOutput[i][6 + j] = "";
                }
            }

            renderPumsumResult();
            
            document.getElementById('pumsumStatTotal').textContent = pumsumFinalOutput.length - 1;
            document.getElementById('pumsumStatScore').textContent = `${totalMatched} Matched`;
            document.getElementById('pumsumStatStatus').textContent = "ì™„ë£Œ";
            
            document.getElementById('pumsumLoading').classList.replace('flex', 'hidden');
            document.getElementById('pumsumResultArea').classList.remove('hidden');
            addLog('Pro v3.5 í’ˆì…ˆ ë¶„ì„ ì™„ë£Œ', 'success');
        }

        function renderPumsumResult() {
            const body = document.getElementById('pumsumResultBody');
            body.innerHTML = '';
            // ìƒìœ„ 100ê°œë§Œ í”„ë¦¬ë·° (ì„±ëŠ¥ ì´ìŠˆ ë°©ì§€)
            const previewRows = pumsumFinalOutput.slice(1, 101); 
            
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-indigo-50 transition-colors";
                const afVal = row[7];
                const afDisplay = afVal ? (isNaN(afVal) ? afVal : Number(afVal).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})) : '';
                
                tr.innerHTML = `
                    <td class="px-3 py-2 border-b border-slate-100 text-slate-700 font-bold truncate">${row[0]}</td>
                    <td class="px-3 py-2 border-b border-slate-100 text-slate-500 truncate">${row[1] || ''}</td>
                    <td class="px-3 py-2 border-b border-slate-100 text-center"><span class="score-badge bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full text-[10px]">${row[14] || 0}</span></td>
                    <td class="px-3 py-2 border-b border-slate-100 text-center font-mono text-indigo-600 font-bold bg-indigo-50/30">${row[4] || '-'}</td>
                    <td class="px-3 py-2 border-b border-slate-100 text-center text-indigo-700 font-bold bg-indigo-50/30 truncate">${row[5] || '-'}</td>
                    <td class="px-3 py-2 border-b border-slate-100 text-center text-slate-400 text-[10px] truncate">${row[6] || ''}</td>
                    <td class="px-3 py-2 border-b border-slate-100 text-center text-emerald-600 font-bold">${afDisplay}</td>
                    <td class="px-3 py-2 border-b border-slate-100 text-center text-slate-400 text-[10px] truncate">${row[8] || ''}</td>
                    <td class="px-3 py-2 border-b border-slate-100 text-center text-slate-400 text-[10px] truncate">${row[9] ? Number(row[9]).toLocaleString() : ''}</td>
                `;
                body.appendChild(tr);
            });
        }

        function exportPumsumToExcel() {
            try {
                const ws = XLSX.utils.aoa_to_sheet(pumsumFinalOutput);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Pro_v3.5_ê²°ê³¼");
                XLSX.writeFile(wb, `í’ˆì…ˆ_ì‚°ì¶œ_v3.5_${new Date().toISOString().slice(0,10)}.xlsx`);
                addLog('í’ˆì…ˆ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
            } catch (err) {
                console.error(err);
                addLog('ì—‘ì…€ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }

        // Initialize
        window.onload = () => {
            fetchDB();
            loadN8nConfig();
        };
    </script>
</body>
</html>
