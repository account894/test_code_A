<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ë¡œë²Œ í™˜ìœ¨ ë° ì›ìì¬ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 700; }
        .tab-inactive { color: #64748b; font-weight: 500; }
        .btn-period-active { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; font-weight: 600; }
        .btn-period-inactive { background-color: #f8fafc; color: #64748b; border-color: #e2e8f0; }
        
        /* Custom Scrollbar for tables */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto space-y-6">
        
        <!-- Header & Tabs -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 p-6 pb-0">
                <div>
                    <h1 class="text-2xl font-bold flex items-center gap-2">
                        <span class="text-3xl">ğŸ“Š</span>
                        ì‹œì¥ ë°ì´í„° ëŒ€ì‹œë³´ë“œ
                    </h1>
                    <p class="text-slate-500 text-sm mt-1 flex items-center gap-1 mb-4">
                        <span>ğŸ•’</span> ë°ì´í„° ê¸°ì¤€ì¼: <span id="lastUpdated" class="font-bold text-blue-600">-</span>
                    </p>
                </div>
                <div class="flex gap-2 items-center mb-4 md:mb-0">
                    <button onclick="window.location.reload()" class="flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-xl transition-all font-medium text-sm">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </header>

            <!-- Tabs Navigation -->
            <div class="flex px-6 border-b border-slate-100">
                <button onclick="switchTab('currency')" id="tab-currency" class="tab-active px-6 py-3 transition-colors hover:text-blue-600 flex items-center gap-2">
                    ğŸ’± í™˜ìœ¨ <span class="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full font-bold">LIVE</span>
                </button>
                <button onclick="switchTab('commodity')" id="tab-commodity" class="tab-inactive px-6 py-3 transition-colors hover:text-blue-600 flex items-center gap-2">
                    ğŸ”© ì›ìì¬ <span class="text-[10px] bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded-full font-bold">LME DATA</span>
                </button>
            </div>
        </div>

        <!-- ================= CURRENCY TAB ================= -->
        <div id="currency-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
            <!-- Alert for Source -->
            <div class="lg:col-span-3 bg-blue-50 border border-blue-100 p-3 rounded-xl flex items-start gap-2 text-sm text-blue-800">
                <span class="mt-0.5">â„¹ï¸</span>
                <div>
                    <span class="font-bold">ë°ì´í„° ì¶œì²˜:</span> ìœ ëŸ½ì¤‘ì•™ì€í–‰(ECB) ê³µì‹ ë°ì´í„° (Frankfurter API). <br>
                    <span class="text-xs text-blue-600">â€» ì‹¤ì œ ê±°ë˜ì¼ ê¸°ì¤€ ë°ì´í„°ì´ë©°, ì£¼ë§/ê³µíœ´ì¼ì—ëŠ” ë³€ë™ì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                </div>
            </div>

            <!-- Current Rate & Converter Card -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col gap-6">
                <!-- Current Rate Display -->
                <div>
                    <h2 class="text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wider">í˜„ì¬ í™˜ìœ¨</h2>
                    <div class="flex items-end gap-2">
                        <span id="displayRate" class="text-4xl font-bold text-slate-800">-</span>
                        <span id="displayCurrency" class="text-lg font-medium text-slate-500 mb-1">KRW</span>
                    </div>
                    <!-- Fluctuation UI -->
                    <div id="fluctuationContainer" class="mt-2 flex items-center gap-2 text-lg font-bold">
                        <span class="text-slate-400 text-sm font-normal">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                    </div>
                </div>

                <hr class="border-slate-100">

                <!-- Converter -->
                <div>
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        ğŸ’± í™˜ìœ¨ ê³„ì‚°ê¸°
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-medium text-slate-400 uppercase tracking-wider">ê¸°ì¤€ í†µí™”</label>
                            <div class="flex gap-2 mt-1">
                                <input type="number" id="amountInput" value="1" min="0" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium">
                                <select id="baseCurrency" class="p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold cursor-pointer">
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="JPY">JPY</option>
                                    <option value="GBP">GBP</option>
                                    <option value="CNY">CNY</option>
                                    <option value="KRW">KRW</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-center py-2">
                            <div class="bg-blue-50 p-2 rounded-full text-blue-500">â¬‡ï¸</div>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-400 uppercase tracking-wider">ëŒ€ìƒ í†µí™”</label>
                            <div class="flex gap-2 mt-1">
                                <div id="convertedResult" class="w-full p-3 bg-blue-50 border border-blue-100 rounded-xl font-bold text-blue-700 text-lg flex items-center">
                                    -
                                </div>
                                <select id="targetCurrency" class="p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold cursor-pointer">
                                    <option value="KRW">KRW</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="JPY">JPY</option>
                                    <option value="GBP">GBP</option>
                                    <option value="CNY">CNY</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Graph Card -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        ğŸ“ˆ <span id="chartTitle">USD/KRW 30ì¼ ì¶”ì´</span>
                    </h2>
                    <span id="changeBadge" class="px-2 py-1 rounded-md font-medium text-sm bg-slate-100 text-slate-500">
                        ë°ì´í„° ë¡œë”© ì¤‘...
                    </span>
                </div>
                <div class="relative h-[350px] w-full">
                    <canvas id="rateChart"></canvas>
                </div>
            </div>

            <!-- Rate Table -->
            <div class="lg:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-6 border-b border-slate-100">
                    <h2 class="text-lg font-semibold">ì£¼ìš” í†µí™” ì‹¤ì‹œê°„ í™˜ìœ¨</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-slate-400 text-xs uppercase tracking-wider font-semibold">
                            <tr>
                                <th class="px-6 py-4">í†µí™”ëª…</th>
                                <th class="px-6 py-4">í™˜ìœ¨</th>
                                <th class="px-6 py-4">ìƒíƒœ</th>
                                <th class="px-6 py-4">ë™ì‘</th>
                            </tr>
                        </thead>
                        <tbody id="ratesTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ================= COMMODITY TAB ================= -->
        <div id="commodity-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in hidden">
            <!-- Alert for Source -->
            <div class="lg:col-span-3 bg-indigo-50 border border-indigo-100 p-4 rounded-xl flex items-start gap-3 text-sm text-indigo-900">
                <span class="mt-0.5 text-lg">ğŸ“‘</span>
                <div>
                    <span class="font-bold text-base">ë°ì´í„° ì¶œì²˜: LME ì‹œì„¸ (Google Sheets ì‹¤ì‹œê°„ ì—°ë™)</span><br>
                    <span class="text-indigo-700">
                        <strong>ì—°ë™ ë°©ì‹:</strong> Google Sheets CSV Export<br>
                        <strong>ë°ì´í„°:</strong> í•œêµ­ë¹„ì² ê¸ˆì†í˜‘íšŒ ê³µì‹ LME ì‹œì„¸ ê¸°ë°˜
                    </span>
                </div>
            </div>

            <!-- Current Material Price Card -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col gap-6">
                <div>
                    <h2 class="text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wider">ìµœì‹  ì‹œì„¸</h2>
                    <div class="flex items-end gap-2">
                        <span id="matDisplayPrice" class="text-4xl font-bold text-slate-800">-</span>
                        <span class="text-lg font-medium text-slate-500 mb-1">USD/Ton</span>
                    </div>
                    <!-- Material Fluctuation UI -->
                    <div id="matFluctuationContainer" class="mt-2 flex items-center gap-2 text-lg font-bold">
                        <span class="text-slate-400 text-sm font-normal">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                    </div>
                </div>

                <hr class="border-slate-100">

                <div>
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        ğŸ—ï¸ ì›ìì¬ ì„ íƒ (LME)
                    </h2>
                    <select id="materialSelect" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold cursor-pointer text-lg">
                        <option value="Cu">êµ¬ë¦¬ (Copper) - ì „ì„ /ë°°ê´€</option>
                        <option value="Al">ì•Œë£¨ë¯¸ëŠ„ (Aluminum) - ë•íŠ¸/ì°½í˜¸</option>
                        <option value="Zn">ì•„ì—° (Zinc) - ë„ê¸ˆ/ê°•íŒ</option>
                        <option value="Pb">ë‚© (Lead) - ë°°ê´€/ì°¨í</option>
                        <option value="Ni">ë‹ˆì¼ˆ (Nickel) - STS í•©ê¸ˆ</option>
                        <option value="Sn">ì£¼ì„ (Tin) - ì†”ë”/ë„ê¸ˆ</option>
                    </select>
                    
                    <div class="mt-4 space-y-2">
                        <p class="text-xs text-slate-400 uppercase tracking-wider font-bold">ë³´ê¸° ê¸°ê°„</p>
                        <div class="flex gap-2">
                            <button onclick="setMaterialViewMode(7)" id="btn-7d" class="flex-1 py-2 px-3 rounded-lg border text-sm transition-all btn-period-inactive">
                                ìµœê·¼ 7ì¼
                            </button>
                            <button onclick="setMaterialViewMode(30)" id="btn-30d" class="flex-1 py-2 px-3 rounded-lg border text-sm transition-all btn-period-active">
                                ìµœê·¼ 30ì¼
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Material Graph Card -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        ğŸ­ <span id="matChartTitle">êµ¬ë¦¬ ê°€ê²© ì¶”ì´</span>
                    </h2>
                    <span id="matChangeBadge" class="px-2 py-1 rounded-md font-medium text-sm bg-slate-100 text-slate-500">
                        ë°ì´í„° ë¡œë”© ì¤‘...
                    </span>
                </div>
                <div class="relative h-[350px] w-full">
                    <canvas id="materialChart"></canvas>
                </div>
            </div>

            <!-- Material Table -->
            <div class="lg:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-6 border-b border-slate-100">
                    <h2 class="text-lg font-semibold">ì£¼ìš” ì›ìì¬ ì‹œì„¸ ëª©ë¡</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-slate-400 text-xs uppercase tracking-wider font-semibold">
                            <tr>
                                <th class="px-6 py-4">í’ˆëª©ëª…</th>
                                <th class="px-6 py-4">ìš©ë„</th>
                                <th class="px-6 py-4">í˜„ì¬ê°€ ($/Ton)</th>
                                <th class="px-6 py-4">ì „ì¼ëŒ€ë¹„</th>
                                <th class="px-6 py-4">ë™ì‘</th>
                            </tr>
                        </thead>
                        <tbody id="materialsTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AI Analysis (Common) -->
        <section class="bg-gradient-to-r from-blue-600 to-indigo-700 p-1 rounded-2xl shadow-lg mt-6">
            <div class="bg-white/95 backdrop-blur-sm p-6 rounded-[14px]">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold flex items-center gap-2 text-indigo-900">
                        âœ¨ AI ë§ˆì¼“ ë¶„ì„
                    </h3>
                    <button id="aiBtn" onclick="analyzeTrend()" class="text-xs font-bold uppercase tracking-widest text-indigo-600 hover:text-indigo-800 bg-indigo-50 px-3 py-1.5 rounded-lg transition-colors">
                        AIì—ê²Œ ë¬¼ì–´ë³´ê¸°
                    </button>
                </div>
                <p id="aiResult" class="text-slate-700 leading-relaxed text-sm">
                    ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í˜„ì¬ ì„ íƒëœ í•­ëª©(í™˜ìœ¨ ë˜ëŠ” ì›ìì¬)ì— ëŒ€í•œ AIì˜ ë¶„ì„ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (API í‚¤ í•„ìš”)
                </p>
            </div>
        </section>

    </div>

    <script>
        // === GLOBAL VARIABLES ===
        const API_BASE = "https://api.frankfurter.app";
        // ì›ìì¬ ë°ì´í„° ì‹œíŠ¸ ID (ê³µê°œ ìƒíƒœì—¬ì•¼ í•¨)
        const SHEET_ID = "1D7hfHKGWzrN3MNItBKkWlKJxFw64gD5mXK3URmfckbI"; 
        const SHEET_NAME = "LME";
        // ì›¹ ê²Œì‹œëœ ì‹œíŠ¸ë¥¼ CSVë¡œ ê°€ì ¸ì˜¤ê¸°
        const SHEET_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
        
        let currentTab = 'currency';
        let materialViewMode = 30; // 7 or 30 days
        
        // Chart Instances
        let currencyChartInstance = null;
        let materialChartInstance = null;
        
        // Data Stores
        let currencyData = { rates: {}, history: [] };
        let materialData = { raw: [], processed: {} };

        // === CONSTANTS ===
        const MATERIAL_INFO = {
            'Cu': { name: 'êµ¬ë¦¬', usage: 'ì „ì„ , ë°°ê´€, ì½”ì¼' },
            'Al': { name: 'ì•Œë£¨ë¯¸ëŠ„', usage: 'ë•íŠ¸, ì°½í˜¸, ê²½ëŸ‰êµ¬ì¡°' },
            'Zn': { name: 'ì•„ì—°', usage: 'ë„ê¸ˆê°•íŒ, ë¶€ì‹ë°©ì§€' },
            'Pb': { name: 'ë‚©', usage: 'ë°°ê´€, ì°¨í, ë°°í„°ë¦¬' },
            'Ni': { name: 'ë‹ˆì¼ˆ', usage: 'ìŠ¤í…Œì¸ë¦¬ìŠ¤ê°• í•©ê¸ˆ' },
            'Sn': { name: 'ì£¼ì„', usage: 'ì†”ë”ë§, ë„ê¸ˆ' }
        };

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            fetchCurrencyData();
            fetchMaterialData();
            
            // Event Listeners
            document.getElementById('amountInput').addEventListener('input', calculateConversion);
            document.getElementById('baseCurrency').addEventListener('change', fetchCurrencyData);
            document.getElementById('targetCurrency').addEventListener('change', fetchCurrencyData);
            document.getElementById('materialSelect').addEventListener('change', updateMaterialUI);
        });

        // === TAB SWITCHING ===
        function switchTab(tabName) {
            currentTab = tabName;
            
            const currencySection = document.getElementById('currency-section');
            const commoditySection = document.getElementById('commodity-section');
            const tabCurrency = document.getElementById('tab-currency');
            const tabCommodity = document.getElementById('tab-commodity');

            if (tabName === 'currency') {
                currencySection.classList.remove('hidden');
                commoditySection.classList.add('hidden');
                tabCurrency.className = "tab-active px-6 py-3 transition-colors hover:text-blue-600 flex items-center gap-2";
                tabCommodity.className = "tab-inactive px-6 py-3 transition-colors hover:text-blue-600 flex items-center gap-2";
                document.getElementById('lastUpdated').innerText = new Date().toLocaleString('ko-KR');
            } else {
                currencySection.classList.add('hidden');
                commoditySection.classList.remove('hidden');
                tabCurrency.className = "tab-inactive px-6 py-3 transition-colors hover:text-blue-600 flex items-center gap-2";
                tabCommodity.className = "tab-active px-6 py-3 transition-colors hover:text-blue-600 flex items-center gap-2";
                if (materialChartInstance) materialChartInstance.resize();
                updateMaterialUI();
                updateLastUpdatedForMaterial();
            }
        }

        // ================= CURRENCY LOGIC =================
        async function fetchCurrencyData() {
            const base = document.getElementById('baseCurrency').value;
            const target = document.getElementById('targetCurrency').value;
            const statusBadge = document.getElementById('changeBadge');
            
            statusBadge.innerText = "ë¡œë”© ì¤‘...";
            if (currentTab === 'currency') {
                document.getElementById('lastUpdated').innerText = new Date().toLocaleString('ko-KR');
            }

            try {
                // Latest
                const latestRes = await fetch(`${API_BASE}/latest?from=${base}`);
                if (!latestRes.ok) throw new Error("Network Error");
                const latestData = await latestRes.json();
                currencyData.rates = latestData.rates;

                // History
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const historyRes = await fetch(`${API_BASE}/${startDate}..${endDate}?from=${base}&to=${target}`);
                const historyData = await historyRes.json();

                currencyData.history = Object.entries(historyData.rates).map(([date, val]) => ({
                    date: date.slice(5),
                    rate: val[target]
                }));

                updateCurrencyUI(base, target);

            } catch (err) {
                console.warn("Currency API failed", err);
                statusBadge.innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
            }
        }

        function updateCurrencyUI(base, target) {
            document.getElementById('chartTitle').innerText = `${base}/${target} 30ì¼ ì¶”ì´`;
            document.getElementById('displayCurrency').innerText = target;
            updateCurrencyFluctuation(target);
            renderChart('rateChart', currencyData.history, 'currency');
            calculateConversion();
            renderCurrencyTable(base);
        }

        function updateCurrencyFluctuation(target) {
            let current = 0, prev = 0;
            if (currencyData.history.length >= 2) {
                current = currencyData.history[currencyData.history.length - 1].rate;
                prev = currencyData.history[currencyData.history.length - 2].rate;
            } else if (currencyData.rates[target]) {
                current = currencyData.rates[target];
                prev = current;
            }

            document.getElementById('displayRate').innerText = current.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            renderFluctuationUI('fluctuationContainer', current, prev);
        }

        function calculateConversion() {
            const amount = parseFloat(document.getElementById('amountInput').value) || 0;
            const target = document.getElementById('targetCurrency').value;
            let rate = currencyData.rates[target] || (currencyData.history.length > 0 ? currencyData.history[currencyData.history.length - 1].rate : 0);
            document.getElementById('convertedResult').innerText = (amount * rate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function renderCurrencyTable(base) {
            const tbody = document.getElementById('ratesTableBody');
            tbody.innerHTML = '';
            const majors = ['USD', 'EUR', 'JPY', 'GBP', 'CNY', 'KRW'];
            
            majors.forEach(curr => {
                if (curr === base) return;
                const rate = currencyData.rates[curr];
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-slate-700">${curr}</td>
                    <td class="px-6 py-4 font-mono font-medium">${rate ? rate.toFixed(4) : '-'}</td>
                    <td class="px-6 py-4 text-xs text-slate-400"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded">ECB Official</span></td>
                    <td class="px-6 py-4">
                        <button onclick="document.getElementById('targetCurrency').value='${curr}'; fetchCurrencyData();" class="text-xs font-semibold text-slate-500 hover:text-blue-600 border border-slate-200 hover:border-blue-400 px-3 py-1 rounded-full transition-all">ë¶„ì„</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ================= COMMODITY LOGIC (GOOGLE SHEETS) =================
        async function fetchMaterialData() {
            try {
                console.log('ğŸ“Š êµ¬ê¸€ ì‹œíŠ¸ CSV ë°ì´í„° ë¡œë”© ì‹œì‘...');
                console.log('ğŸ”— URL:', SHEET_CSV_URL);
                
                const response = await fetch(SHEET_CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ì‹œíŠ¸ ì ‘ê·¼ ì‹¤íŒ¨`);
                }
                
                const csvText = await response.text();
                
                // CSV íŒŒì‹±
                const lines = csvText.split('\n');
                const rawData = [];
                
                // ì²« ë²ˆì§¸ ì¤„ì€ í—¤ë”ì´ë¯€ë¡œ 1ë¶€í„° ì‹œì‘
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // ë¹ˆ ì¤„ ìŠ¤í‚µ
                    
                    // CSV íŒŒì‹± (ë”°ì˜´í‘œ ì²˜ë¦¬)
                    const values = parseCSVLine(line);
                    
                    if (values.length < 7) continue; // ì»¬ëŸ¼ì´ ë¶€ì¡±í•˜ë©´ ìŠ¤í‚µ
                    
                    // Aì—´=ë‚ ì§œ, Bì—´=Cu, Cì—´=Al, Dì—´=Zn, Eì—´=Pb, Fì—´=Ni, Gì—´=Sn
                    const dateStr = values[0].replace(/"/g, '').trim();
                    const cu = parseFloat(values[1]) || 0;
                    const al = parseFloat(values[2]) || 0;
                    const zn = parseFloat(values[3]) || 0;
                    const pb = parseFloat(values[4]) || 0;
                    const ni = parseFloat(values[5]) || 0;
                    const sn = parseFloat(values[6]) || 0;
                    
                    // ë‚ ì§œê°€ ë¹„ì–´ìˆê±°ë‚˜ ëª¨ë“  ê°’ì´ 0ì´ë©´ ìŠ¤í‚µ
                    if (!dateStr || (cu === 0 && al === 0 && zn === 0 && pb === 0 && ni === 0 && sn === 0)) {
                        continue;
                    }
                    
                    rawData.push({
                        date: dateStr,
                        Cu: cu, Al: al, Zn: zn, Pb: pb, Ni: ni, Sn: sn
                    });
                }
                
                if (rawData.length > 0) {
                    console.log(`âœ… ${rawData.length}ê°œ ìœ íš¨ ë°ì´í„° íŒŒì‹± ì™„ë£Œ`);
                } else {
                    throw new Error('íŒŒì‹±ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. CSV í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.');
                }
                
                // ë‚ ì§œìˆœ ì •ë ¬ (ì˜¤ë˜ëœ ê²ƒë¶€í„°)
                rawData.sort((a, b) => {
                    const dateA = a.date.replace(/\./g, '').replace(/-/g, '').replace(/\s+/g, '');
                    const dateB = b.date.replace(/\./g, '').replace(/-/g, '').replace(/\s+/g, '');
                    return dateA.localeCompare(dateB);
                });
                
                materialData.raw = rawData;
                processMaterialData();
                updateMaterialUI();
                
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                
                document.getElementById('matChangeBadge').innerText = "ë¡œë“œ ì‹¤íŒ¨";
                document.getElementById('matDisplayPrice').innerText = "ì˜¤ë¥˜";
                document.getElementById('matFluctuationContainer').innerHTML = 
                    '<span class="text-red-500 text-sm">ë°ì´í„° ì†ŒìŠ¤ ì—°ê²° ì‹¤íŒ¨</span>';
                
                // í™”ë©´ì— ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ (alert ëŒ€ì²´)
                const container = document.getElementById('commodity-section');
                const errorDiv = document.createElement('div');
                errorDiv.className = "lg:col-span-3 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative mt-4";
                errorDiv.innerHTML = `<strong class="font-bold">ì˜¤ë¥˜:</strong> <span class="block sm:inline">${error.message}. êµ¬ê¸€ ì‹œíŠ¸ê°€ ê³µê°œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</span>`;
                container.prepend(errorDiv);
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') { inQuotes = !inQuotes; }
                else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function processMaterialData() {
            const materials = Object.keys(MATERIAL_INFO);
            materials.forEach(mat => {
                materialData.processed[mat] = materialData.raw.map(item => ({
                    date: item.date,
                    rate: item[mat]
                }));
            });
        }

        function setMaterialViewMode(days) {
            materialViewMode = days;
            const btn7 = document.getElementById('btn-7d');
            const btn30 = document.getElementById('btn-30d');
            
            if (days === 7) {
                btn7.className = "flex-1 py-2 px-3 rounded-lg border text-sm transition-all btn-period-active";
                btn30.className = "flex-1 py-2 px-3 rounded-lg border text-sm transition-all btn-period-inactive";
            } else {
                btn7.className = "flex-1 py-2 px-3 rounded-lg border text-sm transition-all btn-period-inactive";
                btn30.className = "flex-1 py-2 px-3 rounded-lg border text-sm transition-all btn-period-active";
            }
            updateMaterialUI();
        }

        function updateMaterialUI() {
            if (!materialData.raw || materialData.raw.length === 0) return;
            
            const selectedMat = document.getElementById('materialSelect').value;
            const fullHistory = materialData.processed[selectedMat] || [];
            
            if (fullHistory.length === 0) return;
            
            // ì„ íƒëœ ê¸°ê°„ë§Œí¼ ë°ì´í„° ì¶”ì¶œ (ìµœì‹  ë°ì´í„°ë¶€í„°)
            const history = fullHistory.slice(-materialViewMode);
            
            // ì°¨íŠ¸ìš© ë‚ ì§œ í¬ë§· (MM.DD í˜•ì‹ìœ¼ë¡œ)
            const chartHistory = history.map(item => {
                let displayDate = item.date;
                if (item.date.includes('.') || item.date.includes('-')) {
                    const parts = item.date.split(/[.-]/);
                    if (parts.length >= 3) {
                        displayDate = `${parts[1]}.${parts[2]}`;
                    }
                }
                return { date: displayDate, rate: item.rate };
            });
            
            // Title
            document.getElementById('matChartTitle').innerText = `${MATERIAL_INFO[selectedMat].name} (${selectedMat}) - ìµœê·¼ ${materialViewMode}ì¼`;
            
            // ìµœì‹  ê°€ê²© í‘œì‹œ
            if (fullHistory.length >= 2) {
                const latestPrice = fullHistory[fullHistory.length - 1].rate;
                const prevPrice = fullHistory[fullHistory.length - 2].rate;
                
                document.getElementById('matDisplayPrice').innerText = latestPrice.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 });
                renderFluctuationUI('matFluctuationContainer', latestPrice, prevPrice);
            }

            // Chart
            renderChart('materialChart', chartHistory, 'material');
            
            // Table
            renderMaterialTable();
            
            // Update last updated date
            updateLastUpdatedForMaterial();
        }

        function updateLastUpdatedForMaterial() {
            if (currentTab === 'commodity' && materialData.raw.length > 0) {
                const latestDate = materialData.raw[materialData.raw.length - 1].date;
                document.getElementById('lastUpdated').innerText = `${latestDate} (êµ¬ê¸€ì‹œíŠ¸ ê¸°ì¤€)`;
            }
        }

        function renderMaterialTable() {
            const tbody = document.getElementById('materialsTableBody');
            tbody.innerHTML = '';
            
            if (!materialData.raw || materialData.raw.length === 0) return;
            
            Object.keys(MATERIAL_INFO).forEach(mat => {
                const info = MATERIAL_INFO[mat];
                const history = materialData.processed[mat];
                
                if (history.length >= 2) {
                    const current = history[history.length - 1].rate;
                    const prev = history[history.length - 2].rate;
                    const diff = current - prev;
                    const diffPercent = (diff / prev) * 100;
                    
                    const colorClass = diff >= 0 ? "text-red-500" : "text-blue-500";
                    const symbol = diff >= 0 ? "â–²" : "â–¼";

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-colors";
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-bold text-slate-700">${info.name} <span class="text-xs text-slate-400 font-normal">(${mat})</span></td>
                        <td class="px-6 py-4 text-xs text-slate-500">${info.usage}</td>
                        <td class="px-6 py-4 font-mono font-medium">$${current.toLocaleString(undefined, {maximumFractionDigits: 1})}</td>
                        <td class="px-6 py-4 text-sm font-bold ${colorClass}">
                             ${symbol} ${Math.abs(diffPercent).toFixed(2)}%
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="document.getElementById('materialSelect').value='${mat}'; updateMaterialUI();" class="text-xs font-semibold text-slate-500 hover:text-blue-600 border border-slate-200 hover:border-blue-400 px-3 py-1 rounded-full transition-all">
                                ì°¨íŠ¸ë³´ê¸°
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }

        // ================= SHARED UI LOGIC =================
        function renderFluctuationUI(containerId, current, prev) {
            const diff = current - prev;
            const diffPercent = prev !== 0 ? (diff / prev) * 100 : 0;
            const container = document.getElementById(containerId);

            let colorClass = "text-slate-500";
            let symbol = "-";
            
            if (diff > 0) { colorClass = "text-red-500"; symbol = "â–²"; }
            else if (diff < 0) { colorClass = "text-blue-500"; symbol = "â–¼"; }

            container.innerHTML = `
                <span class="${colorClass}">${symbol} ${Math.abs(diff).toFixed(2)}</span>
                <span class="${colorClass} text-sm bg-slate-50 px-2 py-1 rounded-lg">
                    ${diffPercent >= 0 ? '+' : ''}${diffPercent.toFixed(2)}%
                </span>
                <span class="text-xs text-slate-400 font-normal ml-1">ì „ì¼ëŒ€ë¹„</span>
            `;
        }

        function renderChart(canvasId, data, type) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const dates = data.map(d => d.date);
            const values = data.map(d => d.rate);
            
            if (values.length === 0) return;
            
            const start = values[0];
            const end = values[values.length - 1];
            const change = ((end - start) / start * 100).toFixed(2);
            
            const badgeId = type === 'currency' ? 'changeBadge' : 'matChangeBadge';
            const badge = document.getElementById(badgeId);
            
            let periodText = type === 'currency' ? "30ì¼" : `${materialViewMode}ì¼`;

            if (change >= 0) {
                badge.className = "px-2 py-1 rounded-md font-medium text-sm bg-red-50 text-red-600";
                badge.innerText = `â–² ${change}% (${periodText})`;
            } else {
                badge.className = "px-2 py-1 rounded-md font-medium text-sm bg-blue-50 text-blue-600";
                badge.innerText = `â–¼ ${change}% (${periodText})`;
            }

            if (type === 'currency') {
                if (currencyChartInstance) currencyChartInstance.destroy();
            } else {
                if (materialChartInstance) materialChartInstance.destroy();
            }

            const lineColor = change >= 0 ? '#ef4444' : '#3b82f6';
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, change >= 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.1)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

            const newChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: type === 'currency' ? 'í™˜ìœ¨' : 'ê°€ê²©($)',
                        data: values,
                        borderColor: lineColor,
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 10 }, maxTicksLimit: 8 } },
                        y: { display: true, position: 'right', grid: { color: '#f1f5f9' } }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });

            if (type === 'currency') currencyChartInstance = newChart;
            else materialChartInstance = newChart;
        }

        // AI Analysis
        async function analyzeTrend() {
            const aiBtn = document.getElementById('aiBtn');
            const aiResult = document.getElementById('aiResult');
            
            let subject = "", start = 0, end = 0;
            let contextText = "";
            
            if (currentTab === 'currency') {
                const base = document.getElementById('baseCurrency').value;
                const target = document.getElementById('targetCurrency').value;
                if (!currencyData.history.length) return;
                subject = `${base}/${target} í™˜ìœ¨`;
                start = currencyData.history[0].rate;
                end = currencyData.history[currencyData.history.length-1].rate;
            } else {
                const mat = document.getElementById('materialSelect').value;
                const matName = MATERIAL_INFO[mat].name;
                
                const history = materialData.processed[mat];
                if (!history || history.length === 0) return;
                
                const viewHistory = history.slice(-materialViewMode);
                subject = `${matName}(${mat}) ì›ìì¬ ê°€ê²©`;
                start = viewHistory[0].rate;
                end = viewHistory[viewHistory.length-1].rate;
                
                contextText = ` (ìµœê·¼ ${materialViewMode}ì¼ LME ì‹œì„¸ ê¸°ë°˜)`;
            }

            aiBtn.innerText = "ë¶„ì„ ì¤‘...";
            aiBtn.disabled = true;
            
            const change = ((end - start) / start * 100).toFixed(2);
            
            // ========================================
            // YOUR API KEY HERE!!
            // Google Gemini API í‚¤ë¥¼ ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”
            // ========================================
            const apiKey = ""; 

            if (!apiKey) {
                aiResult.innerHTML = "<span class='text-red-500 font-bold'>âš ï¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span><br>ì‹¤ì œ AI ë¶„ì„ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì½”ë“œ ë‚´ `apiKey` ë³€ìˆ˜ì— Google Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.";
                aiBtn.innerText = "ì„¤ì • í•„ìš”";
                aiBtn.disabled = false;
                return;
            }

            const prompt = `ìµœê·¼ ê¸°ê°„ë™ì•ˆ ${subject}ì´(ê°€) ì•½ ${change}% ë³€ë™í–ˆìŠµë‹ˆë‹¤${contextText}. ê¸°ê³„ì„¤ë¹„ê³µì‚¬ ê´€ì ì—ì„œ ìì¬ë¹„ ì˜í–¥ì´ë‚˜ ì‹œì¥ ìƒí™©ì„ ì§§ê²Œ í•œê¸€ë¡œ ë¶„ì„í•´ì¤˜.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                aiResult.innerText = data.candidates?.[0]?.content?.parts?.[0]?.text || "ë¶„ì„ ì‹¤íŒ¨";
            } catch (e) {
                aiResult.innerText = "ì—°ê²° ì˜¤ë¥˜ ë°œìƒ";
            } finally {
                aiBtn.innerText = "ë‹¤ì‹œ ë¬¼ì–´ë³´ê¸°";
                aiBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
