<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지능형 적산 매칭 시스템 - Pro v3.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .drop-zone { transition: all 0.3s ease; border-radius: 1rem; }
        .drop-zone:hover { border-color: #4f46e5; background-color: #f5f3ff; }
        .score-badge { background: #e0e7ff; color: #4338ca; font-weight: 800; padding: 2px 10px; border-radius: 99px; font-size: 11px; }
        .table-container { max-height: 600px; overflow-y: auto; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #818cf8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2.5 rounded-xl shadow-lg shadow-indigo-200">
                    <i class="fa-solid fa-bolt-lightning text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">지능형 적산 매칭 엔진 <span class="text-indigo-600">v3.5</span></h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest text-indigo-600">Engine v3.5 - Comma & Range Precision Fix</p>
                </div>
            </div>
            <div class="flex items-center gap-4 text-xs font-bold text-slate-500 bg-slate-100 px-4 py-2 rounded-full border border-slate-200">
                <span id="dbBadge" class="flex items-center gap-1.5 text-slate-400"><i class="fa-solid fa-database"></i> DB Disconnected</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-10 space-y-8">

        <!-- Status Box -->
        <div id="statusAlert" class="hidden p-4 rounded-2xl bg-white border border-slate-200 shadow-sm mb-6 flex items-center gap-3 border-l-4 border-l-indigo-600">
            <div id="statusColor" class="w-3 h-3 rounded-full bg-indigo-500 shadow-inner"></div>
            <span id="statusText" class="text-sm font-bold text-slate-600 tracking-tight">시스템 준비됨</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- 01 DB Sync -->
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 p-8 hover:shadow-xl transition-all">
                <h3 class="text-sm font-black text-slate-400 mb-4 uppercase tracking-widest italic">Step 01. Cloud Sync</h3>
                <h2 class="text-2xl font-black mb-6 italic underline decoration-indigo-500 underline-offset-4">마스터베이스 동기화</h2>
                <button onclick="fetchGoogleSheet()" id="syncBtn" class="group w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all flex items-center justify-center gap-3">
                    <i class="fa-solid fa-rotate"></i>
                    <span>구글 스프레드시트 데이터 로드</span>
                </button>
            </div>

            <!-- 02 Upload -->
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 p-8 hover:shadow-xl transition-all">
                <h3 class="text-sm font-black text-slate-400 mb-4 uppercase tracking-widest italic">Step 02. Bill Upload</h3>
                <h2 class="text-2xl font-black mb-6 italic underline decoration-indigo-500 underline-offset-4">공내역서 파일 업로드</h2>
                <input type="file" id="targetInput" class="hidden" accept=".xlsx, .xls" onchange="handleBillUpload(event)">
                <label for="targetInput" class="drop-zone border-2 border-dashed border-slate-200 py-10 flex flex-col items-center justify-center cursor-pointer group">
                    <i class="fa-solid fa-file-excel text-slate-300 text-3xl group-hover:text-indigo-500 transition-colors mb-2"></i>
                    <span class="text-sm font-bold text-slate-500 group-hover:text-indigo-600">엑셀 파일을 업로드하세요 (쉼표 수치 지원)</span>
                    <span id="fileName" class="text-[11px] mt-2 text-indigo-500 font-bold truncate px-4 text-center"></span>
                </label>
            </div>
        </div>

        <!-- Engine Control -->
        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 p-10">
            <div class="flex flex-col md:flex-row items-center justify-between gap-8 mb-10">
                <div class="max-w-lg">
                    <h2 class="text-3xl font-black italic tracking-tighter decoration-indigo-500 underline underline-offset-8">Precision Engine v3.5</h2>
                    <p class="text-sm text-slate-400 mt-4 font-medium leading-relaxed italic">
                        쉼표(,)가 포함된 수치를 정확히 인식하여 범위(`~`) 규격을 검증합니다. <br>
                        [품명+규격] 통합 키워드 검색으로 최상위 유사도를 도출합니다.
                    </p>
                </div>
                <div class="flex gap-4 w-full md:w-auto">
                    <button id="matchBtn" onclick="runMatchingEngine()" disabled class="flex-1 md:flex-none bg-indigo-600 text-white px-12 py-5 rounded-2xl font-black hover:bg-indigo-700 disabled:bg-slate-100 disabled:text-slate-300 shadow-xl shadow-indigo-100 transition-all">
                        정밀 매칭 시작
                    </button>
                    <button id="downloadBtn" onclick="downloadResult()" disabled class="flex-1 md:flex-none bg-emerald-600 text-white px-12 py-5 rounded-2xl font-black hover:bg-emerald-700 disabled:bg-slate-100 disabled:text-slate-300 shadow-xl shadow-emerald-100 transition-all">
                        결과 다운로드
                    </button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mb-10 p-8 bg-slate-50 rounded-[1.5rem] border border-slate-100 shadow-inner">
                <div class="flex justify-between items-end mb-4">
                    <div class="flex flex-col gap-1">
                        <span id="progressStep" class="text-[10px] font-black text-slate-400 uppercase tracking-widest tracking-tighter">Comma-Aware Numerical Scanning...</span>
                        <span id="progressRow" class="text-sm font-bold text-slate-600 tracking-tight">대기 중</span>
                    </div>
                    <span id="progressPercent" class="text-4xl font-black text-indigo-600 tracking-tighter">0%</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden shadow-inner">
                    <div id="progressBar" class="bg-indigo-600 h-full w-0 transition-all duration-300 shadow-[0_0_15px_rgba(79,70,229,0.4)]"></div>
                </div>
            </div>

            <!-- Preview Table -->
            <div class="rounded-2xl overflow-hidden border border-slate-200 bg-white shadow-sm">
                <div class="table-container">
                    <table class="w-full text-left text-[11px] border-collapse min-w-[1200px]">
                        <thead class="bg-slate-50 border-b border-slate-200 sticky top-0 z-10 shadow-sm">
                            <tr class="text-slate-500 font-black uppercase tracking-widest">
                                <th class="px-4 py-5">공내역서 품명</th>
                                <th class="px-4 py-5">입력 규격</th>
                                <th class="px-4 py-5 text-center bg-indigo-50/50">매칭 점수</th>
                                <th class="px-4 py-5 text-center bg-indigo-50/50">DB코드</th>
                                <th class="px-4 py-5 text-center bg-indigo-50/50 text-indigo-700 font-black">DB규격(최적)</th>
                                <th class="px-4 py-5 text-center">AE (텍스트)</th>
                                <th class="px-4 py-5 text-center text-emerald-600 font-bold">AF*수량 (결과)</th>
                            </tr>
                        </thead>
                        <tbody id="previewBody" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="7" class="px-6 py-24 text-center text-slate-400 italic font-medium">분석을 시작하면 쉼표 교정 및 [품명+규격] 통합 분석 결과가 표시됩니다.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        let masterDB = [];
        let sourceBill = [];
        let finalOutput = [];

        // 텍스트 정규화 유틸리티 (수치 제외 키워드 검색용)
        const clean = (s) => String(s || "").toLowerCase().replace(/[^a-z0-9가-힣ø]/g, "");

        // 숫자 파싱 유틸리티: 쉼표 제거 로직 추가 (18,400 -> 18400)
        const normalizeNumbers = (s) => {
            if (!s) return "";
            // 숫자 사이에 있는 쉼표만 제거 (단어 사이 쉼표는 유지)
            return String(s).replace(/(\d),(?=\d{3})/g, '$1');
        };

        // 규격 수치 분석 (쉼표가 제거된 상태에서 수행)
        const parseSpec = (s) => {
            if (!s) return [];
            const results = [];
            const cleanS = normalizeNumbers(s);
            // 숫자(소수점 포함)와 문자 단위(ø 포함)를 쌍으로 추출
            const regex = /(\d+\.?\d*)\s*([a-z가-힣%ø]+)|([a-z가-힣%ø]+)\s*(\d+\.?\d*)/gi;
            let m;
            while ((m = regex.exec(cleanS)) !== null) {
                let v = parseFloat(m[1] || m[4]);
                let u = (m[2] || m[3]).toLowerCase();
                results.push({ val: v, unit: u });
            }
            return results;
        };

        // 범위(~) 매칭 체크 (쉼표 대응 로직 포함)
        const checkRange = (val, dbSpec) => {
            if (!dbSpec.includes('~')) return false;
            const cleanDbSpec = normalizeNumbers(dbSpec);
            const parts = cleanDbSpec.split('~');
            const minM = parts[0].match(/(\d+\.?\d*)/);
            const maxM = parts[1].match(/(\d+\.?\d*)/);
            if (minM && maxM) {
                const min = parseFloat(minM[1]);
                const max = parseFloat(maxM[1]);
                // 범위 안에 있는지 엄격하게 비교
                return val >= min && val <= max;
            }
            return false;
        };

        // 규격 비교 로직 (v3.5: 쉼표 교정 및 엄격 범위 매칭)
        const compareStrictPrecision = (userStr, dbSpecStr) => {
            const userPairs = parseSpec(userStr);
            const dbPairs = parseSpec(dbSpecStr);
            const isBelowCondition = dbSpecStr.includes("이하");
            const hasRangeCondition = dbSpecStr.includes("~");

            if (dbPairs.length === 0) return { valid: true, specScore: 0 };

            let matchScore = 0;
            for (const dp of dbPairs) {
                const up = userPairs.find(x => x.unit === dp.unit);
                if (up) {
                    // 1. 범위 조건(~) 우선 판단
                    if (hasRangeCondition) {
                        if (checkRange(up.val, dbSpecStr)) {
                            matchScore++;
                            continue;
                        } else {
                            return { valid: false }; // 범위를 벗어나면 탈락
                        }
                    }

                    // 2. 고정 수치 및 조건 판단
                    if (dp.unit === 't' || dp.unit === 'kg') {
                        if (up.val !== dp.val) return { valid: false };
                    } else if (dp.unit === 'd' || dp.unit === 'ø') {
                        if (isBelowCondition) {
                            if (up.val > dp.val) return { valid: false };
                        } else {
                            if (up.val !== dp.val) return { valid: false };
                        }
                    } else {
                        // 일반 단위 비교 (쉼표 제거된 수치 기반)
                        if (up.val !== dp.val) return { valid: false };
                    }
                    matchScore++;
                } else {
                    return { valid: false };
                }
            }
            return { valid: true, specScore: matchScore };
        };

        async function fetchGoogleSheet() {
            const btn = document.getElementById('syncBtn');
            const badge = document.getElementById('dbBadge');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Syncing...';
            updateStatus("Cloud Database에서 고정밀 품셈 데이터를 동기화하는 중...", "indigo");

            try {
                const id = "1zQtfJZFsZ2PccBm4ul1JrOaKKOVN_FYmjV3GhJzYpJA";
                const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=Table종합`;
                const res = await fetch(url);
                const txt = await res.text();
                const json = JSON.parse(txt.substring(47).slice(0, -2));
                
                masterDB = json.table.rows.map(r => {
                    const rowData = r.c;
                    return {
                        keywords: rowData.slice(0, 26).map(c => c && c.v ? String(c.v).trim() : "").filter(v => v !== ""),
                        code: rowData[26] ? rowData[26].v : "",
                        spec: rowData[27] ? String(rowData[27].v) : "",
                        extraData: rowData.slice(30, 38).map(c => c ? c.v : "")
                    };
                }).filter(d => d.keywords.length > 0 || d.code);

                badge.innerHTML = `<i class="fa-solid fa-database text-indigo-500"></i> Connected (${masterDB.length})`;
                badge.classList.remove('text-slate-400');
                badge.classList.add('text-indigo-600');
                updateStatus("동기화 완료! 쉼표 포함 수치를 처리할 준비가 되었습니다.", "emerald");
                if (sourceBill.length > 0) document.getElementById('matchBtn').disabled = false;
            } catch (e) {
                updateStatus("DB 연결 오류. 공유 설정을 확인하세요.", "rose");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-rotate mr-2"></i> 구글 스프레드시트 데이터 로드';
            }
        }

        function handleBillUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'});
                sourceBill = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
                document.getElementById('fileName').innerText = file.name;
                updateStatus("내역서 로드 성공! 쉼표(,)를 자동 교정하여 분석합니다.", "emerald");
                if (masterDB.length > 0) document.getElementById('matchBtn').disabled = false;
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 매칭 엔진 가동 (v3.5 - Comma Normalization & Strict Range) ---
        async function runMatchingEngine() {
            const btn = document.getElementById('matchBtn');
            const bar = document.getElementById('progressBar');
            const percent = document.getElementById('progressPercent');
            const step = document.getElementById('progressStep');
            const rowTxt = document.getElementById('progressRow');
            const body = document.getElementById('previewBody');

            btn.disabled = true;
            finalOutput = JSON.parse(JSON.stringify(sourceBill));
            
            if (finalOutput[0]) {
                finalOutput[0][4] = "DB품셈코드";
                finalOutput[0][5] = "DB규격";
                const headers = ["AE(텍스트)", "AF(수량곱)", "AG(텍스트)", "AH(수량곱)", "AI(텍스트)", "AJ(수량곱)", "AK(텍스트)", "AL(수량곱)", "매칭점수"];
                for(let j=0; j<9; j++) finalOutput[0][6 + j] = headers[j];
            }

            body.innerHTML = '';
            step.innerText = "Scanning Global Database with Comma-Normalization Engine...";
            const total = finalOutput.length - 1;

            const excludeKeywords = ['엘보', '티이', '레듀샤', '리듀서', '소켓', '유니온', '어댑터', '아답타', '이음쇠', '이음관', '서포트'];

            for (let i = 1; i < finalOutput.length; i++) {
                const row = finalOutput[i];
                if (!row || !row[0]) continue;

                const itemName = String(row[0]).trim();
                const itemSpec = String(row[1] || "").trim();
                const userQty = parseFloat(normalizeNumbers(String(row[3]))) || 0; // 수량에도 쉼표가 있을 경우 대비

                // 검색 대상 통합 및 쉼표 정규화 (품명+규격)
                const searchBase = normalizeNumbers(itemName + " " + itemSpec).toLowerCase();

                let bestMatch = null;
                let currentMaxScore = -1;
                let bestSpecScore = -1;

                const hasExcludeKeyword = excludeKeywords.some(kw => itemName.includes(kw) || itemSpec.includes(kw));

                if (!hasExcludeKeyword) {
                    for (const dbEntry of masterDB) {
                        let cellScore = 0;
                        
                        // DB 키워드 셀 단위 검색
                        dbEntry.keywords.forEach(kw => {
                            if (searchBase.includes(kw.toLowerCase())) {
                                cellScore++; 
                            }
                        });

                        if (cellScore > 0 && cellScore >= currentMaxScore) {
                            // 규격 비교 (쉼표가 제거된 깨끗한 수치들로 비교)
                            const specCheck = compareStrictPrecision(itemSpec, dbEntry.spec);
                            
                            if (specCheck.valid) {
                                if (cellScore > currentMaxScore || (cellScore === currentMaxScore && specCheck.specScore > bestSpecScore)) {
                                    currentMaxScore = cellScore;
                                    bestSpecScore = specCheck.specScore;
                                    bestMatch = dbEntry;
                                }
                            }
                        }
                    }
                }

                if (bestMatch) {
                    finalOutput[i][4] = bestMatch.code;
                    finalOutput[i][5] = bestMatch.spec;
                    finalOutput[i][14] = currentMaxScore;

                    for (let j = 0; j < 8; j++) {
                        const dbVal = bestMatch.extraData[j];
                        const targetIdx = 6 + j;
                        if ([1, 3, 5, 7].includes(j)) {
                            // 숫자형 필드 수량곱 (DB 값에도 쉼표가 있을 수 있으므로 처리)
                            const val = parseFloat(normalizeNumbers(String(dbVal))) || 0;
                            finalOutput[i][targetIdx] = val * userQty;
                        } else {
                            finalOutput[i][targetIdx] = dbVal;
                        }
                    }
                } else {
                    finalOutput[i][4] = "";
                    finalOutput[i][5] = "";
                    finalOutput[i][14] = 0;
                    for (let j = 0; j < 8; j++) finalOutput[i][6 + j] = "";
                }

                if (i % 20 === 0 || i === total) {
                    const p = Math.round((i / total) * 100);
                    bar.style.width = p + '%';
                    percent.innerText = p + '%';
                    rowTxt.innerText = `분석 중: ${i} / ${total} 행 완료 (천 단위 교정 중)`;
                    if (i % 100 === 0) await new Promise(r => setTimeout(r, 0));
                }

                if (i < 201 && i % 10 === 0) {
                    updatePreview(row, finalOutput[i][4], finalOutput[i][5], currentMaxScore > 0 ? currentMaxScore : 0, finalOutput[i][7]);
                }
            }

            step.innerText = "Engine Scan Complete";
            rowTxt.innerText = "쉼표 수치 및 범위 매칭 교정이 완료되었습니다.";
            updateStatus("분석 성공! 결과물을 다운로드 하세요.", "emerald");
            document.getElementById('downloadBtn').disabled = false;
            btn.disabled = false;
        }

        function updatePreview(row, code, spec, score, afCalc) {
            const body = document.getElementById('previewBody');
            const tr = document.createElement('tr');
            tr.className = "hover:bg-indigo-50/50 transition-all animate-in fade-in";
            tr.innerHTML = `
                <td class="px-4 py-4 font-bold text-slate-700">${row[0]}</td>
                <td class="px-4 py-4 text-slate-500 font-medium">${row[1] || ''}</td>
                <td class="px-4 py-4 text-center"><span class="score-badge">${score} Hits</span></td>
                <td class="px-4 py-4 font-mono text-indigo-600 font-black text-center bg-indigo-50/20">${code || '-'}</td>
                <td class="px-4 py-4 text-indigo-700 font-black text-center bg-indigo-50/30">${spec || '-'}</td>
                <td class="px-4 py-4 text-slate-500 text-center">${row[6] || ''}</td>
                <td class="px-4 py-4 text-emerald-600 font-bold text-center">${afCalc ? (isNaN(afCalc) ? afCalc : Number(afCalc).toLocaleString()) : ''}</td>
            `;
            body.appendChild(tr);
        }

        function downloadResult() {
            const ws = XLSX.utils.aoa_to_sheet(finalOutput);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "PreciseMatch_v3.5");
            XLSX.writeFile(wb, `적산정밀분석_v3.5_${new Date().getTime()}.xlsx`);
        }

        function updateStatus(msg, color) {
            const alert = document.getElementById('statusAlert');
            const dot = document.getElementById('statusColor');
            const txt = document.getElementById('statusText');
            alert.classList.remove('hidden');
            dot.className = `w-3 h-3 rounded-full bg-${color}-500 shadow-inner`;
            txt.innerText = msg;
        }
    </script>
</body>
</html>
